<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>生命导航 - 健康与人生规划</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#FAF6F1;--card:#FFFFFF;
--glass:rgba(120,90,60,0.04);--glass-border:rgba(120,90,60,0.10);
--cyan:#2A9D8F;--coral:#E76F51;--gold:#E9A820;--green:#40916C;--purple:#7B68A8;
--lavender:#9381BE;--orange:#E07A3A;--blue:#4A8FBF;
--text:#3A3028;--text2:rgba(58,48,40,0.6);--text3:rgba(58,48,40,0.3);
--font:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;
--mono:'SF Mono','Menlo','Consolas',monospace,-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;
--radius:14px;--nav-h:68px;--header-h:52px;
--sidebar-w:240px;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--font);-webkit-tap-highlight-color:transparent;overscroll-behavior:none}
body{display:flex;align-items:stretch}

/* ====== STARFIELD ====== */
#starfield{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}

/* ====== APP CONTAINER - DESKTOP FLEX ROW ====== */
#app{width:100%;height:100vh;height:100dvh;display:flex;flex-direction:row;position:relative;overflow:hidden;z-index:1}

/* ====== SIDEBAR NAVIGATION ====== */
.bottom-nav{
  width:var(--sidebar-w);min-width:var(--sidebar-w);height:100vh;
  position:fixed;left:0;top:0;z-index:20;
  display:flex;flex-direction:column;align-items:stretch;
  background:rgba(255,255,255,0.92);backdrop-filter:blur(24px);
  border-right:1px solid var(--glass-border);
  padding:0;
  box-shadow:2px 0 20px rgba(120,90,60,0.06);
}
.sidebar-brand{
  padding:28px 24px 20px;text-align:center;
  border-bottom:1px solid var(--glass-border);
}
.sidebar-brand-icon{font-size:36px;margin-bottom:4px;display:block}
.sidebar-brand-text{
  font-size:22px;font-weight:700;
  background:linear-gradient(135deg,var(--cyan),var(--purple));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  letter-spacing:3px;
}
.sidebar-brand-sub{font-size:11px;color:var(--text2);margin-top:2px}

.sidebar-nav{flex:1;display:flex;flex-direction:column;padding:16px 12px;gap:4px}
.nav-item{
  display:flex;flex-direction:row;align-items:center;gap:14px;
  padding:14px 18px;cursor:pointer;
  border-radius:12px;
  transition:all 0.25s ease;
  position:relative;
  -webkit-user-select:none;user-select:none;
}
.nav-item:hover{background:rgba(42,157,143,0.06)}
.nav-item .nav-icon{font-size:22px;transition:transform 0.3s ease;flex-shrink:0;width:28px;text-align:center}
.nav-item .nav-label{font-size:14px;font-weight:500;color:var(--text2);transition:color 0.3s ease;white-space:nowrap}
.nav-item.active{background:rgba(42,157,143,0.08)}
.nav-item.active .nav-icon{transform:scale(1.1)}
.nav-item.active .nav-label{color:var(--cyan);font-weight:600}
.nav-item.active::before{
  content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);
  width:4px;height:28px;border-radius:0 4px 4px 0;
  background:var(--cyan);
  box-shadow:0 0 10px rgba(42,157,143,0.4);
}
.nav-item:active{transform:scale(0.97)}
/* Remove old bottom-nav active dot */
.nav-item.active::after{display:none}

.sidebar-footer{
  padding:16px 18px;border-top:1px solid var(--glass-border);
  display:flex;flex-direction:column;gap:6px;
}
.sidebar-user{font-size:12px;color:var(--text2);display:flex;align-items:center;gap:6px;padding:4px 0}
.sidebar-logout{
  font-size:12px;color:var(--text2);cursor:pointer;
  background:none;border:1px solid var(--glass-border);border-radius:8px;
  padding:6px 14px;font-family:var(--font);transition:all 0.25s;
  text-align:center;
}
.sidebar-logout:hover{border-color:var(--coral);color:var(--coral)}

/* ====== HIDE OLD HEADER - info goes to sidebar ====== */
.app-header{display:none!important}

/* ====== MAIN CONTENT AREA ====== */
.pages-container{
  margin-left:var(--sidebar-w);flex:1;
  height:100vh;height:100dvh;overflow:hidden;position:relative;z-index:5;
}
.page{
  display:none;
  width:100%;height:100%;
  overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  padding:32px 40px 40px;
  scrollbar-width:thin;
  scrollbar-color:rgba(120,90,60,0.15) transparent;
}
.page::-webkit-scrollbar{width:6px}
.page::-webkit-scrollbar-thumb{background:rgba(120,90,60,0.15);border-radius:3px}
.page::-webkit-scrollbar-track{background:transparent}
.page.active{display:block;opacity:1;transform:none}
.page.exit-left{display:none;opacity:0}

/* Page header titles */
.page-heading{
  font-size:26px;font-weight:700;color:var(--text);margin-bottom:24px;
  display:flex;align-items:center;gap:10px;
}

/* ====== CARDS - DESKTOP HOVER ====== */
.card{
  background:var(--card);border:1px solid var(--glass-border);border-radius:var(--radius);
  padding:18px 22px;backdrop-filter:blur(16px);
  transition:transform 0.2s ease,box-shadow 0.2s ease;
  box-shadow:0 2px 8px rgba(120,90,60,0.06);
}
.card:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(120,90,60,0.10)}
.card:active{transform:scale(0.99)}

.section-title{font-size:17px;font-weight:600;color:var(--text);margin:24px 0 14px;display:flex;align-items:center;gap:8px}
.section-title:first-child{margin-top:4px}

/* ====== HEALTH METRICS - 4 COLUMN GRID ====== */
.grid-2{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}

/* ====== DEVICE CARDS - HORIZONTAL ROW ====== */
.device-scroll{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
  gap:12px;padding:4px 0 8px;
}
.device-card{
  min-width:0;padding:16px;border-radius:12px;
  background:var(--card);border:1px solid var(--glass-border);
  display:flex;flex-direction:column;align-items:center;gap:8px;
  cursor:pointer;
  transition:transform 0.2s ease,box-shadow 0.2s ease;
  box-shadow:0 1px 4px rgba(120,90,60,0.05);
}
.device-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(120,90,60,0.10)}
.device-card:active{transform:scale(0.97)}
.device-card.connected{border-color:rgba(64,145,108,0.3);box-shadow:0 0 12px rgba(64,145,108,0.08)}
.device-card .dev-icon{font-size:30px}
.device-card .dev-name{font-size:12px;color:var(--text2);text-align:center}
.device-card .dev-status{font-size:11px;color:var(--text3);display:flex;align-items:center;gap:3px}
.device-card.connected .dev-status{color:var(--green)}
.device-card .sync-btn{font-size:11px;padding:5px 14px;border-radius:20px;border:1px solid var(--cyan);color:var(--cyan);background:transparent;cursor:pointer;transition:all 0.25s ease}
.device-card .sync-btn:hover{background:var(--cyan);color:#fff}
.device-card .sync-btn:active{background:var(--cyan);color:#fff}
.device-card.connected .sync-btn{border-color:var(--green);color:var(--green)}
.device-card.connected .sync-btn:hover{background:var(--green);color:#fff}
.device-card.connecting .sync-btn{border-color:var(--gold);color:var(--gold);animation:pulse-border 1s infinite}
@keyframes pulse-border{0%,100%{opacity:1}50%{opacity:0.5}}

/* ====== HEALTH METRIC CARDS ====== */
.metric-card{padding:16px;position:relative;overflow:hidden}
.metric-card .metric-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.metric-card .metric-icon{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px}
.metric-card .metric-trend{font-size:13px;display:flex;align-items:center;gap:2px}
.metric-card .metric-value{font-family:var(--mono);font-size:28px;font-weight:800;letter-spacing:1px;line-height:1.1}
.metric-card .metric-unit{font-size:12px;color:var(--text2);font-weight:400;margin-left:2px}
.metric-card .metric-label{font-size:12px;color:var(--text2);margin-top:3px}
.metric-card .sparkline-wrap{height:36px;margin-top:8px}
.metric-card .metric-time{font-size:10px;color:var(--text3);margin-top:4px}

/* ====== MODAL - CENTERED OVERLAY ====== */
.modal-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);z-index:100;
  opacity:0;pointer-events:none;transition:opacity 0.3s ease;
  display:flex;align-items:center;justify-content:center;
}
.modal-overlay.show{opacity:1;pointer-events:auto}
.modal-sheet{
  width:90%;max-width:560px;max-height:85vh;
  background:#FFFCF8;
  border-radius:20px;
  transform:scale(0.92) translateY(20px);opacity:0;
  transition:transform 0.35s cubic-bezier(0.32,0.72,0,1),opacity 0.3s ease;
  overflow-y:auto;
  scrollbar-width:thin;
  padding:0 28px 28px;
  box-shadow:0 20px 60px rgba(0,0,0,0.15);
}
.modal-sheet::-webkit-scrollbar{width:4px}
.modal-sheet::-webkit-scrollbar-thumb{background:rgba(120,90,60,0.15);border-radius:2px}
.modal-overlay.show .modal-sheet{transform:scale(1) translateY(0);opacity:1}
.modal-handle{width:36px;height:4px;border-radius:2px;background:rgba(120,90,60,0.2);margin:14px auto 20px}
.modal-title{font-size:19px;font-weight:600;text-align:center;margin-bottom:20px}
.form-group{margin-bottom:16px}
.form-label{font-size:13px;color:var(--text2);margin-bottom:6px;display:block}
.form-input{width:100%;padding:11px 16px;background:rgba(120,90,60,0.04);border:1px solid var(--glass-border);border-radius:10px;color:var(--text);font-size:14px;font-family:var(--font);outline:none;transition:border-color 0.3s}
.form-input:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(42,157,143,0.08)}
.form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='rgba(58,48,40,0.6)' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-check-group{display:flex;flex-wrap:wrap;gap:8px}
.form-check{padding:7px 14px;border-radius:20px;border:1px solid var(--glass-border);font-size:13px;color:var(--text2);cursor:pointer;transition:all 0.25s;background:transparent}
.form-check:hover{border-color:var(--cyan);color:var(--cyan)}
.form-check.selected{border-color:var(--cyan);color:var(--cyan);background:rgba(42,157,143,0.08)}
.btn{padding:13px 28px;border-radius:12px;border:none;font-size:15px;font-weight:600;font-family:var(--font);cursor:pointer;transition:all 0.25s ease;display:flex;align-items:center;justify-content:center;gap:6px}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.1)}
.btn:active{transform:scale(0.97)}
.btn-primary{background:linear-gradient(135deg,var(--cyan),#1a7a6f);color:#fff;width:100%}
.btn-primary:hover{box-shadow:0 4px 16px rgba(42,157,143,0.3)}
.btn-outline{background:transparent;border:1px solid var(--cyan);color:var(--cyan)}
.btn-outline:hover{background:rgba(42,157,143,0.06)}
.btn-small{padding:7px 16px;font-size:13px;border-radius:8px}

/* ====== TAB 2 - AI ANALYSIS: DASHBOARD LAYOUT ====== */
.ai-dashboard-row{
  display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;
}
.life-clock-wrap{display:flex;flex-direction:column;align-items:center;padding:24px 0 14px}
.life-clock-ring{position:relative;width:180px;height:180px}
.life-clock-ring canvas{position:absolute;top:0;left:0}
.life-clock-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.life-clock-years{font-family:var(--mono);font-size:44px;font-weight:800;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px;line-height:1}
.life-clock-label{font-size:12px;color:var(--text2);margin-top:2px}
.life-expect{font-size:14px;color:var(--text2);margin-top:10px}

.health-score-wrap{display:flex;align-items:center;gap:20px;padding:20px}
.score-ring{position:relative;width:90px;height:90px;flex-shrink:0}
.score-ring canvas{position:absolute;top:0;left:0}
.score-ring-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.score-ring-value{font-family:var(--mono);font-size:30px;font-weight:800;letter-spacing:1px;line-height:1}
.score-ring-label{font-size:10px;color:var(--text2)}
.score-bars{flex:1;display:flex;flex-direction:column;gap:8px}
.score-bar-item{display:flex;align-items:center;gap:10px}
.score-bar-name{font-size:12px;color:var(--text2);width:72px;flex-shrink:0;text-align:right}
.score-bar-track{flex:1;height:7px;background:rgba(120,90,60,0.08);border-radius:4px;overflow:hidden}
.score-bar-fill{height:100%;border-radius:4px;transition:width 1s ease}
.score-bar-val{font-size:11px;color:var(--text2);width:24px;font-family:var(--mono)}

.gen-report-btn{margin:16px 0}
.analyzing-wrap{text-align:center;padding:40px 0}
.analyzing-spinner{width:50px;height:50px;border:3px solid var(--glass-border);border-top-color:var(--cyan);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.analyzing-stage{font-size:15px;color:var(--text2)}

/* Report sections - multi column where appropriate */
.report-section{margin-top:20px}
.report-section .rs-title{font-size:17px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;color:var(--text)}
.report-narrative{font-size:14px;color:var(--text2);line-height:1.8;margin-bottom:12px}
.range-indicator{margin:8px 0;position:relative}
.range-bar{height:8px;border-radius:4px;background:linear-gradient(90deg,var(--green),var(--gold),var(--coral));position:relative}
.range-marker{position:absolute;top:-4px;width:3px;height:16px;background:var(--text);border-radius:1px;transform:translateX(-50%)}
.range-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--text3);margin-top:3px}

/* Risk cards - 2 column grid on desktop */
.risk-cards-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.risk-card{padding:14px;margin-bottom:0;border-left:3px solid;position:relative}
.risk-card.risk-high{border-left-color:var(--coral);background:rgba(231,111,81,0.06)}
.risk-card.risk-medium{border-left-color:var(--orange);background:rgba(224,122,58,0.06)}
.risk-card.risk-watch{border-left-color:var(--gold);background:rgba(233,168,32,0.06)}
.risk-card.risk-normal{border-left-color:var(--green);background:rgba(64,145,108,0.06)}
.risk-card .risk-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.risk-card .risk-name{font-size:15px;font-weight:600}
.risk-card .risk-badge{font-size:11px;padding:3px 10px;border-radius:10px;font-weight:600}
.risk-high .risk-badge{background:rgba(231,111,81,0.15);color:var(--coral)}
.risk-medium .risk-badge{background:rgba(224,122,58,0.15);color:var(--orange)}
.risk-watch .risk-badge{background:rgba(233,168,32,0.15);color:var(--gold)}
.risk-normal .risk-badge{background:rgba(64,145,108,0.15);color:var(--green)}
.risk-card .risk-desc{font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:4px}
.risk-card .risk-systems{font-size:11px;color:var(--text3)}
.risk-card .risk-action{font-size:12px;color:var(--cyan);margin-top:4px}

/* Recommendation cards */
.rec-cards-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.rec-card{padding:16px;margin-bottom:0;border:1px solid var(--glass-border);position:relative}
.rec-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(120,90,60,0.10)}
.rec-card .rec-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.rec-card .rec-icon{font-size:22px}
.rec-card .rec-title{font-size:15px;font-weight:600;flex:1}
.rec-card .rec-priority{font-size:11px;padding:3px 10px;border-radius:10px}
.rec-priority.urgent{background:rgba(231,111,81,0.15);color:var(--coral)}
.rec-priority.important{background:rgba(233,168,32,0.15);color:var(--gold)}
.rec-priority.recommended{background:rgba(64,145,108,0.15);color:var(--green)}
.rec-card .rec-desc{font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:8px}
.rec-card .rec-target{font-size:12px;color:var(--cyan);margin-bottom:3px}
.rec-card .rec-timeline{font-size:12px;color:var(--text3)}
.rec-card .rec-benefit{font-size:12px;color:var(--green);margin-top:3px}

.waterfall-item{display:flex;align-items:center;gap:12px;padding:7px 0;border-bottom:1px solid var(--glass-border)}
.waterfall-item:last-child{border-bottom:none}
.wf-label{font-size:13px;color:var(--text2);width:110px;flex-shrink:0;text-align:right}
.wf-bar-wrap{flex:1;display:flex;align-items:center;justify-content:center;position:relative;height:20px}
.wf-bar{height:14px;border-radius:7px;min-width:4px}
.wf-bar.positive{background:var(--green)}
.wf-bar.negative{background:var(--coral)}
.wf-value{font-size:12px;font-family:var(--mono);width:50px;text-align:right;flex-shrink:0}
.wf-value.positive{color:var(--green)}
.wf-value.negative{color:var(--coral)}
.chart-container{position:relative;height:240px;margin:16px 0}
.monitor-card{display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:8px}
.monitor-card:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(120,90,60,0.08)}
.monitor-card .mon-icon{font-size:20px;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(120,90,60,0.04)}
.monitor-card .mon-info{flex:1}
.monitor-card .mon-name{font-size:14px;font-weight:500}
.monitor-card .mon-freq{font-size:12px;color:var(--text2)}

/* ====== TAB 3 - TIME MANAGEMENT: SIDE-BY-SIDE ====== */
.time-top-row{display:grid;grid-template-columns:1fr 1.5fr;gap:24px;margin-bottom:20px;align-items:start}
.countdown-wrap{text-align:center;padding:24px 0}
.date-display{font-size:15px;color:var(--text2);margin-bottom:10px}
.countdown-time{font-family:var(--mono);font-size:52px;font-weight:800;letter-spacing:2px;background:linear-gradient(135deg,var(--cyan),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.day-progress-wrap{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:12px}
.day-ring{width:44px;height:44px;position:relative}
.day-ring canvas{position:absolute;top:0;left:0}
.day-ring-pct{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;font-family:var(--mono);color:var(--text2)}
.day-progress-label{font-size:13px;color:var(--text2)}

.time-task-panel{display:flex;flex-direction:column}
.quick-add-bar{display:flex;gap:10px;margin:0 0 14px}
.quick-add-input{flex:1;padding:11px 16px;background:rgba(120,90,60,0.04);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:var(--font);outline:none;transition:border-color 0.3s}
.quick-add-input:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(42,157,143,0.08)}
.priority-sel{display:flex;border:1px solid var(--glass-border);border-radius:10px;overflow:hidden}
.priority-opt{padding:9px 12px;font-size:12px;cursor:pointer;border:none;background:transparent;color:var(--text3);font-family:var(--font);transition:all 0.25s}
.priority-opt:hover{background:rgba(120,90,60,0.04)}
.priority-opt.active{color:#fff}
.priority-opt.p-high.active{background:var(--coral);color:#fff}
.priority-opt.p-med.active{background:var(--gold);color:#fff}
.priority-opt.p-low.active{background:var(--green);color:#fff}
.add-btn{width:44px;height:44px;border-radius:12px;border:none;background:var(--cyan);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.25s}
.add-btn:hover{background:#1a7a6f;box-shadow:0 4px 12px rgba(42,157,143,0.3)}
.add-btn:active{transform:scale(0.92)}

.stats-bar{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:0 0 16px}
.stat-card{text-align:center;padding:12px;background:var(--card);border:1px solid var(--glass-border);border-radius:10px;box-shadow:0 1px 4px rgba(120,90,60,0.05);transition:transform 0.2s,box-shadow 0.2s}
.stat-card:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(120,90,60,0.08)}
.stat-num{font-family:var(--mono);font-size:24px;font-weight:700;letter-spacing:1px}
.stat-label{font-size:11px;color:var(--text2);margin-top:3px}

.task-group{margin-bottom:14px}
.task-group-title{font-size:13px;font-weight:600;padding:8px 12px;border-radius:8px 8px 0 0;display:flex;align-items:center;gap:6px}
.task-group-title.tg-high{background:rgba(231,111,81,0.1);color:var(--coral)}
.task-group-title.tg-med{background:rgba(233,168,32,0.1);color:var(--gold)}
.task-group-title.tg-low{background:rgba(64,145,108,0.1);color:var(--green)}
.task-item{display:flex;align-items:center;gap:12px;padding:11px 14px;border-bottom:1px solid var(--glass-border);background:var(--card);transition:all 0.2s}
.task-item:hover{background:rgba(42,157,143,0.02)}
.task-item:last-child{border-bottom:none;border-radius:0 0 8px 8px}
.task-check{width:22px;height:22px;border-radius:50%;border:2px solid var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.25s;flex-shrink:0;background:transparent}
.task-check:hover{border-color:var(--green)}
.task-check.checked{border-color:var(--green);background:var(--green)}
.task-check.checked::after{content:'\2713';font-size:12px;color:#fff}
.task-text{flex:1;font-size:14px;transition:all 0.3s}
.task-text.done{text-decoration:line-through;color:var(--text3)}
.task-priority{font-size:10px;padding:3px 8px;border-radius:8px;flex-shrink:0}
.tp-high{background:rgba(231,111,81,0.15);color:var(--coral)}
.tp-med{background:rgba(233,168,32,0.15);color:var(--gold)}
.tp-low{background:rgba(64,145,108,0.15);color:var(--green)}
.task-time{font-size:11px;color:var(--text3);font-family:var(--mono);flex-shrink:0}
.task-del{width:26px;height:26px;border-radius:6px;border:none;background:rgba(231,111,81,0.1);color:var(--coral);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.25s;opacity:0.5}
.task-del:hover{opacity:1;background:rgba(231,111,81,0.18)}
.task-del:active{transform:scale(0.9)}
.completed-section{opacity:0.6}

/* ====== TAB 4 - LIFE PLANNING: WIDER GRID ====== */
.life-top-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
.remain-banner{text-align:center;padding:20px 0}
.remain-years{font-family:var(--mono);font-size:56px;font-weight:800;letter-spacing:2px;background:linear-gradient(135deg,var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.1}
.remain-label{font-size:15px;color:var(--text2);margin-top:6px}
.goal-progress-wrap{display:flex;align-items:center;gap:18px;padding:18px}
.goal-ring{position:relative;width:60px;height:60px;flex-shrink:0}
.goal-ring canvas{position:absolute;top:0;left:0}
.goal-ring-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:14px;font-family:var(--mono);font-weight:700;color:var(--text)}
.goal-progress-text{font-size:14px;color:var(--text2)}

.cat-filter{display:flex;gap:8px;flex-wrap:wrap;padding:8px 0;scrollbar-width:none;-ms-overflow-style:none}
.cat-filter::-webkit-scrollbar{display:none}
.cat-chip{padding:7px 16px;border-radius:20px;border:1px solid var(--glass-border);font-size:13px;color:var(--text2);cursor:pointer;white-space:nowrap;transition:all 0.25s;flex-shrink:0;background:transparent;font-family:var(--font)}
.cat-chip:hover{border-color:var(--cyan);color:var(--cyan)}
.cat-chip.active{border-color:var(--cyan);color:var(--cyan);background:rgba(42,157,143,0.08)}

.life-timeline{position:relative;height:56px;margin:16px 0;background:var(--card);border-radius:10px;border:1px solid var(--glass-border);overflow:visible;padding:0 12px}
.timeline-bar{position:absolute;top:50%;left:12px;right:12px;height:4px;background:rgba(120,90,60,0.08);border-radius:2px;transform:translateY(-50%)}
.timeline-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--cyan),var(--purple))}
.timeline-marker{position:absolute;top:50%;width:10px;height:10px;border-radius:50%;transform:translate(-50%,-50%);cursor:pointer;z-index:2;transition:all 0.3s}
.timeline-marker:hover{transform:translate(-50%,-50%) scale(1.3)}
.timeline-marker .tm-label{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);font-size:9px;white-space:nowrap;color:var(--text2);pointer-events:none}

/* Goals in a wider grid */
.goals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.goal-card{padding:18px;margin-bottom:0;position:relative}
.goal-card:hover .goal-del{opacity:1}
.goal-card .goal-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.goal-card .goal-emoji{font-size:26px}
.goal-card .goal-title{font-size:15px;font-weight:600;flex:1}
.goal-card .goal-cat{font-size:11px;padding:3px 10px;border-radius:10px;background:rgba(42,157,143,0.08);color:var(--cyan)}
.goal-card .goal-desc{font-size:13px;color:var(--text2);line-height:1.5;margin-bottom:8px}
.goal-card .goal-footer{display:flex;align-items:center;justify-content:space-between}
.goal-card .goal-age{font-size:12px;color:var(--text3)}
.goal-card .goal-status{font-size:11px;padding:4px 12px;border-radius:10px;cursor:pointer;border:none;font-family:var(--font);transition:all 0.25s}
.goal-card .goal-status:hover{transform:scale(1.05)}
.status-pending{background:rgba(58,48,40,0.06);color:var(--text2)}
.status-progress{background:rgba(42,157,143,0.12);color:var(--cyan)}
.status-done{background:rgba(64,145,108,0.12);color:var(--green)}
.goal-card .goal-del{position:absolute;top:12px;right:12px;width:24px;height:24px;border-radius:6px;border:none;background:rgba(231,111,81,0.1);color:var(--coral);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s}
.goal-card .goal-del:hover{background:rgba(231,111,81,0.18)}

.preset-chips{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
.preset-chip{padding:8px 16px;border-radius:20px;border:1px solid var(--glass-border);font-size:13px;color:var(--text2);cursor:pointer;transition:all 0.25s;background:transparent;font-family:var(--font)}
.preset-chip:hover{border-color:var(--cyan);color:var(--cyan);background:rgba(42,157,143,0.04)}
.preset-chip:active{border-color:var(--cyan);color:var(--cyan);transform:scale(0.95)}

/* ====== ANIMATIONS ====== */
@keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade-in-up{animation:fadeInUp 0.4s ease forwards}
.hidden{display:none!important}

/* ====== AUTH SCREEN - CENTERED CARD ====== */
#authScreen{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:var(--bg);z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  transition:opacity 0.4s ease,transform 0.4s ease;
}
#authScreen.auth-hidden{opacity:0;pointer-events:none;visibility:hidden;transform:translateY(-20px)}
#authScreen.auth-gone{display:none!important}
.auth-container{width:100%;max-width:440px;padding:0 32px}
.auth-logo{text-align:center;margin-bottom:40px}
.auth-logo-icon{font-size:56px;margin-bottom:10px}
.auth-logo-text{font-size:32px;font-weight:700;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:4px}
.auth-logo-sub{font-size:14px;color:var(--text2);margin-top:6px}
.auth-card{background:var(--card);border:1px solid var(--glass-border);border-radius:20px;padding:32px 28px;box-shadow:0 8px 40px rgba(120,90,60,0.10)}
.auth-title{font-size:20px;font-weight:600;text-align:center;margin-bottom:24px;color:var(--text)}
.auth-input-group{margin-bottom:16px;position:relative}
.auth-input-label{font-size:13px;color:var(--text2);margin-bottom:6px;display:block}
.auth-input{width:100%;padding:13px 16px;background:rgba(120,90,60,0.04);border:1px solid var(--glass-border);border-radius:10px;color:var(--text);font-size:15px;font-family:var(--font);outline:none;transition:border-color 0.3s,box-shadow 0.3s}
.auth-input:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(42,157,143,0.08)}
.auth-input::placeholder{color:var(--text3)}
.auth-phone-row{display:flex;gap:10px}
.auth-phone-prefix{width:64px;padding:13px 8px;background:rgba(120,90,60,0.04);border:1px solid var(--glass-border);border-radius:10px;color:var(--text2);font-size:15px;text-align:center;flex-shrink:0;line-height:1.2}
.auth-phone-input{flex:1}
.auth-sms-row{display:flex;gap:10px}
.auth-sms-input{flex:1}
.auth-sms-btn{min-width:110px;padding:13px 10px;border-radius:10px;border:1px solid var(--cyan);background:transparent;color:var(--cyan);font-size:14px;font-family:var(--font);cursor:pointer;transition:all 0.25s;white-space:nowrap}
.auth-sms-btn:hover{background:rgba(42,157,143,0.06)}
.auth-sms-btn:active{transform:scale(0.96)}
.auth-sms-btn:disabled{border-color:var(--text3);color:var(--text3);cursor:not-allowed}
.auth-pwd-wrap{position:relative}
.auth-pwd-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:16px;cursor:pointer;color:var(--text3);padding:4px}
.auth-submit{width:100%;padding:14px;border-radius:12px;border:none;font-size:16px;font-weight:600;font-family:var(--font);background:linear-gradient(135deg,var(--cyan),#1a7a6f);color:#fff;cursor:pointer;transition:all 0.25s;margin-top:8px}
.auth-submit:hover{box-shadow:0 6px 20px rgba(42,157,143,0.3)}
.auth-submit:active{transform:scale(0.97)}
.auth-submit:disabled{opacity:0.6;cursor:not-allowed}
.auth-links{display:flex;justify-content:space-between;margin-top:16px;font-size:14px}
.auth-link{color:var(--cyan);cursor:pointer;background:none;border:none;font-family:var(--font);font-size:14px;padding:0}
.auth-link:hover{text-decoration:underline}
.auth-link:active{opacity:0.7}
.auth-error{color:#fff;font-size:14px;text-align:center;margin-top:12px;min-height:20px;font-weight:600;padding:0;border-radius:8px;transition:all 0.3s ease;overflow:hidden;max-height:0}
.auth-error.visible{background:var(--coral);padding:10px 16px;max-height:60px}
.auth-error.shake{animation:authShake 0.5s ease}
@keyframes authShake{0%,100%{transform:translateX(0)}15%{transform:translateX(-10px)}30%{transform:translateX(10px)}45%{transform:translateX(-6px)}60%{transform:translateX(6px)}75%{transform:translateX(-2px)}90%{transform:translateX(2px)}}
.auth-view{display:none}
.auth-view.active{display:block}

/* These classes are added dynamically by JS to the app-header. We hide the header, 
   but the JS updateAuthUI function creates these elements. We style them for sidebar instead. */
.auth-logout-btn{display:none!important}
.auth-user-info{display:none!important}

/* ====== RESPONSIVE: < 768px ====== */
@media(max-width:768px){
  :root{--sidebar-w:0px}
  .bottom-nav{
    width:100%;height:auto;position:fixed;bottom:0;left:0;top:auto;
    flex-direction:row;border-right:none;border-top:1px solid var(--glass-border);
    box-shadow:0 -2px 16px rgba(120,90,60,0.06);
    padding:8px 0 env(safe-area-inset-bottom);z-index:20;
  }
  .sidebar-brand{display:none}
  .sidebar-nav{flex-direction:row;padding:0;gap:0;justify-content:space-around;align-items:center}
  .nav-item{flex-direction:column;gap:3px;padding:8px 12px;border-radius:0}
  .nav-item .nav-label{font-size:10px}
  .nav-item .nav-icon{width:auto}
  .nav-item.active::before{display:none}
  .nav-item.active::after{
    display:block;content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);
    width:4px;height:4px;border-radius:50%;background:var(--cyan);box-shadow:0 0 8px var(--cyan);
  }
  .sidebar-footer{display:none}
  .pages-container{margin-left:0;padding-bottom:70px}
  .page{padding:16px 14px 20px}
  .grid-2{grid-template-columns:1fr 1fr}
  .device-scroll{grid-template-columns:repeat(auto-fill,minmax(110px,1fr))}
  .ai-dashboard-row{grid-template-columns:1fr}
  .time-top-row{grid-template-columns:1fr}
  .life-top-row{grid-template-columns:1fr}
  .goals-grid{grid-template-columns:1fr}
  .risk-cards-grid{grid-template-columns:1fr}
  .rec-cards-grid{grid-template-columns:1fr}
  .page-heading{font-size:20px;margin-bottom:16px}
  .challenge-cards{grid-template-columns:1fr 1fr}
  .medal-grid{grid-template-columns:repeat(auto-fill,minmax(80px,1fr))}
  .streak-grid{grid-template-columns:repeat(auto-fill,minmax(16px,1fr))}
  .level-card{flex-direction:column;text-align:center;gap:12px}
  .nav-item .nav-label{font-size:9px}
  .nav-item{padding:6px 8px}
}

/* ====== RESPONSIVE: 769-1024px ====== */
@media(min-width:769px) and (max-width:1024px){
  .grid-2{grid-template-columns:repeat(3,1fr)}
  .goals-grid{grid-template-columns:repeat(2,1fr)}
  .medal-grid{grid-template-columns:repeat(auto-fill,minmax(90px,1fr))}
  .challenge-cards{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
}

/* ====== RESPONSIVE: > 1400px ====== */
@media(min-width:1400px){
  .page{padding:36px 56px 48px}
  .grid-2{grid-template-columns:repeat(4,1fr);gap:20px}
  .device-scroll{grid-template-columns:repeat(auto-fill,minmax(170px,1fr))}
}

/* ====== TAB 5 - ACHIEVEMENT SYSTEM ====== */
.level-card{
  background:linear-gradient(135deg,rgba(42,157,143,0.08),rgba(123,104,168,0.08));
  border:1px solid var(--glass-border);border-radius:var(--radius);
  padding:24px;display:flex;align-items:center;gap:20px;
  margin-bottom:20px;position:relative;overflow:hidden;
}
.level-card::after{
  content:'';position:absolute;top:-50%;right:-20%;width:200px;height:200px;
  background:radial-gradient(circle,rgba(42,157,143,0.06) 0%,transparent 70%);
  pointer-events:none;
}
.level-icon{font-size:48px;flex-shrink:0}
.level-info{flex:1}
.level-name{font-size:22px;font-weight:700;color:var(--text);margin-bottom:2px}
.level-lv{font-size:13px;color:var(--text2);margin-bottom:8px}
.level-points{font-family:var(--mono);font-size:14px;color:var(--cyan);margin-bottom:8px}
.level-progress{height:8px;background:rgba(120,90,60,0.08);border-radius:4px;overflow:hidden;position:relative}
.level-progress-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--cyan),var(--purple));transition:width 0.8s ease}
.level-progress-text{font-size:11px;color:var(--text3);margin-top:4px}

.streak-card{
  background:var(--card);border:1px solid var(--glass-border);border-radius:var(--radius);
  padding:20px;margin-bottom:20px;
}
.streak-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.streak-fire{font-size:36px}
.streak-count{font-family:var(--mono);font-size:32px;font-weight:800;color:var(--orange)}
.streak-label{font-size:13px;color:var(--text2)}
.streak-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(18px,1fr));gap:3px}
.streak-day{width:100%;aspect-ratio:1;border-radius:3px;background:rgba(120,90,60,0.06);transition:background 0.3s}
.streak-day.active-1{background:rgba(42,157,143,0.2)}
.streak-day.active-2{background:rgba(42,157,143,0.4)}
.streak-day.active-3{background:rgba(42,157,143,0.7)}
.streak-day.active-4{background:var(--cyan)}
.streak-day.today{outline:2px solid var(--cyan);outline-offset:1px}

.challenge-section{margin-bottom:20px}
.challenge-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.challenge-card{
  background:var(--card);border:1px solid var(--glass-border);border-radius:12px;
  padding:16px;text-align:center;transition:all 0.25s;position:relative;overflow:hidden;
}
.challenge-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(120,90,60,0.08)}
.challenge-card.completed{border-color:rgba(64,145,108,0.3);background:rgba(64,145,108,0.04)}
.challenge-card .ch-icon{font-size:28px;margin-bottom:8px}
.challenge-card .ch-desc{font-size:13px;color:var(--text2);margin-bottom:8px;min-height:36px}
.challenge-card .ch-points{font-size:12px;color:var(--gold);font-weight:600}
.challenge-card .ch-status{font-size:11px;margin-top:6px;padding:3px 10px;border-radius:10px;display:inline-block}
.challenge-card .ch-status.done{background:rgba(64,145,108,0.12);color:var(--green)}
.challenge-card .ch-status.pending{background:rgba(120,90,60,0.06);color:var(--text3)}

.medal-section{margin-bottom:20px}
.medal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
.medal-item{
  background:var(--card);border:1px solid var(--glass-border);border-radius:12px;
  padding:14px 8px;text-align:center;transition:all 0.3s;position:relative;
}
.medal-item:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(120,90,60,0.08)}
.medal-item.unlocked{border-color:rgba(233,168,32,0.3);box-shadow:0 0 12px rgba(233,168,32,0.08)}
.medal-item.locked{opacity:0.55;filter:grayscale(0.5)}
.medal-item .medal-icon{font-size:32px;margin-bottom:6px;display:block}
.medal-item .medal-name{font-size:11px;font-weight:600;color:var(--text);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.medal-item .medal-desc{font-size:10px;color:var(--text3);line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.medal-item .medal-lock{position:absolute;top:6px;right:6px;font-size:10px;color:var(--text3)}
.medal-item .medal-tier{font-size:9px;color:var(--gold);margin-top:3px}

.points-log-section{margin-bottom:20px}
.points-log{display:flex;flex-direction:column;gap:0}
.points-log-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-bottom:1px solid var(--glass-border);
  background:var(--card);transition:background 0.2s;
}
.points-log-item:first-child{border-radius:var(--radius) var(--radius) 0 0}
.points-log-item:last-child{border-radius:0 0 var(--radius) var(--radius);border-bottom:none}
.points-log-item:only-child{border-radius:var(--radius)}
.points-log-item:hover{background:rgba(42,157,143,0.02)}
.points-log-reason{font-size:13px;color:var(--text);flex:1}
.points-log-amount{font-family:var(--mono);font-size:14px;font-weight:700;color:var(--green);margin-left:12px}
.points-log-time{font-size:11px;color:var(--text3);margin-left:12px;white-space:nowrap}

/* ====== ONBOARDING CARD ====== */
@keyframes onboardSlideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.onboarding-card{
  background:linear-gradient(135deg,#FFF8EE 0%,#FFF2E0 100%);
  border:1px solid rgba(233,168,32,0.3);border-radius:var(--radius);
  padding:22px 20px 18px;margin:16px 0 8px;
  animation:onboardSlideUp 0.5s ease both;
  position:relative;
}
.onboarding-card-title{font-size:17px;font-weight:700;color:var(--text);margin-bottom:2px;display:flex;align-items:center;gap:8px}
.onboarding-card-sub{font-size:13px;color:var(--text2);margin-bottom:16px}
.onboarding-steps{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.onboarding-step{
  flex:1;min-width:90px;background:var(--card);border-radius:10px;padding:14px 10px;
  text-align:center;border:1px solid var(--glass-border);
  transition:transform 0.2s,box-shadow 0.2s;
}
.onboarding-step:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(120,90,60,0.08)}
.onboarding-step-num{
  width:26px;height:26px;border-radius:50%;
  background:var(--cyan);color:#fff;font-size:13px;font-weight:700;
  display:inline-flex;align-items:center;justify-content:center;margin-bottom:6px;
}
.onboarding-step-icon{font-size:22px;margin-bottom:4px;display:block}
.onboarding-step-text{font-size:12px;color:var(--text);font-weight:500}
.onboarding-actions{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.onboarding-dismiss{
  font-size:12px;color:var(--text3);cursor:pointer;border:none;background:none;
  font-family:var(--font);padding:4px 0;transition:color 0.2s;
}
.onboarding-dismiss:hover{color:var(--text2)}

/* ====== REPORT ACTIONS (Save as Image) ====== */
.report-actions{
  display:flex;gap:10px;margin-top:14px;max-width:400px;flex-wrap:wrap;
}
.btn-save-report{
  display:inline-flex;align-items:center;gap:6px;
  font-size:14px;padding:10px 18px;
}

/* ====== PERIODIC REPORT (Weekly/Monthly) ====== */
.periodic-section{margin-top:32px;padding-top:24px;border-top:1px solid var(--glass-border)}
.period-tabs{display:flex;gap:6px;margin-bottom:18px}
.period-tab{
  padding:8px 22px;border-radius:20px;
  background:var(--glass);border:1px solid var(--glass-border);
  font-size:14px;font-weight:500;color:var(--text2);
  cursor:pointer;font-family:var(--font);transition:all 0.25s;
}
.period-tab:hover{border-color:var(--cyan);color:var(--cyan)}
.period-tab.active{background:var(--cyan);color:#fff;border-color:var(--cyan)}
.period-report-card{
  background:var(--card);border:1px solid var(--glass-border);
  border-radius:var(--radius);padding:18px 16px;margin-bottom:14px;
}
.period-report-card-title{
  font-size:15px;font-weight:600;color:var(--text);margin-bottom:12px;
  display:flex;align-items:center;gap:8px;
}
.period-stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.period-stat-item{
  background:var(--glass);border-radius:10px;padding:12px;
  display:flex;flex-direction:column;gap:2px;
}
.period-stat-label{font-size:11px;color:var(--text2)}
.period-stat-value{font-size:20px;font-weight:700;color:var(--text);font-family:var(--mono)}
.period-stat-sub{font-size:11px;color:var(--text3);display:flex;align-items:center;gap:4px}
.period-trend-up{color:var(--green)}
.period-trend-down{color:var(--coral)}
.period-trend-flat{color:var(--text3)}
.period-chart-wrap{margin-top:14px;background:var(--glass);border-radius:10px;padding:14px}
.period-chart-wrap canvas{width:100%!important;max-height:180px}
.period-insight{
  padding:12px 14px;border-radius:10px;margin-bottom:8px;
  font-size:13px;color:var(--text);line-height:1.6;
  display:flex;align-items:flex-start;gap:8px;
}
.period-insight-good{background:rgba(64,145,108,0.06);border-left:3px solid var(--green)}
.period-insight-warn{background:rgba(233,168,32,0.06);border-left:3px solid var(--gold)}
.period-insight-info{background:rgba(42,157,143,0.06);border-left:3px solid var(--cyan)}
.period-insight-icon{font-size:16px;flex-shrink:0;margin-top:1px}
.period-no-data{text-align:center;padding:40px 20px;color:var(--text3);font-size:14px}
.period-save-btn{margin-top:12px}

</style>
</head>
<body>

<!-- Auth Screen -->
<div id="authScreen">
  <div class="auth-container">
    <div class="auth-logo">
      <div class="auth-logo-icon">&#x1F9ED;</div>
      <div class="auth-logo-text">&#x751F;&#x547D;&#x5BFC;&#x822A;</div>
      <div class="auth-logo-sub">&#x5065;&#x5EB7;&#x4E0E;&#x4EBA;&#x751F;&#x89C4;&#x5212;</div>
    </div>
    <div class="auth-card">
      <div class="auth-title">&#x624B;&#x673A;&#x53F7;&#x767B;&#x5F55;</div>
      <div class="auth-input-group">
        <label class="auth-input-label">&#x624B;&#x673A;&#x53F7;</label>
        <div class="auth-phone-row">
          <div class="auth-phone-prefix">+86</div>
          <input class="auth-input auth-phone-input" id="loginPhone" type="tel" placeholder="&#x8BF7;&#x8F93;&#x5165;&#x624B;&#x673A;&#x53F7;" maxlength="11" inputmode="numeric">
        </div>
      </div>
      <div class="auth-input-group">
        <label class="auth-input-label">&#x9A8C;&#x8BC1;&#x7801;</label>
        <div class="auth-sms-row">
          <input class="auth-input auth-sms-input" id="loginCode" type="tel" placeholder="6&#x4F4D;&#x9A8C;&#x8BC1;&#x7801;" maxlength="6" inputmode="numeric">
          <button class="auth-sms-btn" id="loginSmsBtn" onclick="getLoginCode()">&#x83B7;&#x53D6;&#x9A8C;&#x8BC1;&#x7801;</button>
        </div>
      </div>
      <div id="codeDisplay" style="text-align:center;margin:10px 0;font-size:14px;color:var(--text2);min-height:22px"></div>
      <button class="auth-submit" id="loginSubmitBtn" onclick="doLogin()">&#x767B;&#x5F55;</button>
      <div class="auth-error" id="loginError"></div>
      <div id="authDebug" style="font-size:11px;color:#999;text-align:center;margin-top:16px">v6 - 2026.02.15</div>
    </div>
  </div>
</div>

<canvas id="starfield"></canvas>
<div id="app" style="display:none">

<!-- SIDEBAR NAVIGATION -->
<nav class="bottom-nav">
  <div class="sidebar-brand">
    <span class="sidebar-brand-icon">&#x1F9ED;</span>
    <div class="sidebar-brand-text">&#x751F;&#x547D;&#x5BFC;&#x822A;</div>
    <div class="sidebar-brand-sub">&#x5065;&#x5EB7;&#x4E0E;&#x4EBA;&#x751F;&#x89C4;&#x5212;</div>
  </div>
  <div class="sidebar-nav">
    <div class="nav-item active" onclick="switchTab(0)" data-tab="0">
      <span class="nav-icon">&#x2764;&#xFE0F;</span><span class="nav-label">&#x5065;&#x5EB7;&#x6570;&#x636E;</span>
    </div>
    <div class="nav-item" onclick="switchTab(1)" data-tab="1">
      <span class="nav-icon">&#x1F9E0;</span><span class="nav-label">AI &#x5206;&#x6790;</span>
    </div>
    <div class="nav-item" onclick="switchTab(2)" data-tab="2">
      <span class="nav-icon">&#x23F0;</span><span class="nav-label">&#x65F6;&#x95F4;&#x7BA1;&#x7406;</span>
    </div>
    <div class="nav-item" onclick="switchTab(3)" data-tab="3">
      <span class="nav-icon">&#x1F31F;</span><span class="nav-label">&#x4EBA;&#x751F;&#x89C4;&#x5212;</span>
    </div>
    <div class="nav-item" onclick="switchTab(4)" data-tab="4">
      <span class="nav-icon">&#x1F3C6;</span><span class="nav-label">&#x6211;&#x7684;&#x6210;&#x5C31;</span>
    </div>
  </div>
  <div class="sidebar-footer" id="sidebarFooter">
    <div class="sidebar-user" id="sidebarUser"></div>
    <button class="sidebar-logout" id="sidebarLogout" onclick="doLogout()" style="display:none">&#x9000;&#x51FA;&#x767B;&#x5F55;</button>
  </div>
</nav>

<!-- Hidden header for JS compatibility (updateAuthUI targets .app-header) -->
<header class="app-header"><div class="app-title">&#x751F;&#x547D;&#x5BFC;&#x822A;</div></header>

<div class="pages-container">
<!-- PAGE 1: Health Data -->
<div class="page active" id="page-health">
  <div class="page-heading">&#x2764;&#xFE0F; &#x5065;&#x5EB7;&#x6570;&#x636E;</div>

  <div id="onboardingCard"></div>

  <div class="section-title">&#x1F4F1; &#x6570;&#x636E;&#x6765;&#x6E90;</div>
  <div class="device-scroll" id="deviceScroll"></div>

  <div class="section-title">&#x1F4CA; &#x5065;&#x5EB7;&#x6307;&#x6807;</div>
  <div class="grid-2" id="metricsGrid"></div>

  <div style="margin-top:18px;max-width:400px">
    <button class="btn btn-outline" onclick="openManualEntry()" style="width:100%">&#x270F;&#xFE0F; &#x624B;&#x52A8;&#x5F55;&#x5165;&#x5065;&#x5EB7;&#x6570;&#x636E;</button>
  </div>
</div>

<!-- PAGE 2: AI Analysis -->
<div class="page" id="page-ai">
  <div class="page-heading">&#x1F9E0; AI &#x667A;&#x80FD;&#x5206;&#x6790;</div>
  <div class="ai-dashboard-row">
    <div class="card life-clock-wrap">
      <div class="life-clock-ring">
        <canvas id="lifeClockCanvas" width="180" height="180"></canvas>
        <div class="life-clock-center">
          <div class="life-clock-years" id="lifeClockYears">--</div>
          <div class="life-clock-label">&#x9884;&#x8BA1;&#x5269;&#x4F59;&#x5E74;</div>
        </div>
      </div>
      <div class="life-expect" id="lifeExpectText">&#x8BF7;&#x5148;&#x5F55;&#x5165;&#x5065;&#x5EB7;&#x6570;&#x636E;</div>
    </div>

    <div class="card health-score-wrap">
      <div class="score-ring">
        <canvas id="scoreRingCanvas" width="90" height="90"></canvas>
        <div class="score-ring-center">
          <div class="score-ring-value" id="scoreValue">--</div>
          <div class="score-ring-label">&#x5065;&#x5EB7;&#x5206;</div>
        </div>
      </div>
      <div class="score-bars" id="scoreBars"></div>
    </div>
  </div>

  <div style="max-width:400px">
    <button class="btn btn-primary gen-report-btn" id="genReportBtn" onclick="generateReport()">&#x1F52C; &#x751F;&#x6210;&#x8BE6;&#x7EC6;&#x62A5;&#x544A;</button>
  </div>

  <div id="analyzingWrap" class="analyzing-wrap hidden">
    <div class="analyzing-spinner"></div>
    <div class="analyzing-stage" id="analyzingStage">&#x91C7;&#x96C6;&#x6570;&#x636E;...</div>
  </div>

  <div id="reportContainer" class="hidden"></div>

  <div id="reportActions" class="report-actions hidden">
    <button class="btn btn-outline btn-save-report" id="saveReportBtn" onclick="saveReportAsImage()">&#x1F4E5; &#x4FDD;&#x5B58;&#x62A5;&#x544A;&#x4E3A;&#x56FE;&#x7247;</button>
    <button class="btn btn-outline btn-save-report" id="savePeriodicBtn" onclick="savePeriodicReportAsImage()" style="display:none">&#x1F4E5; &#x4FDD;&#x5B58;&#x5468;&#x62A5;&#x4E3A;&#x56FE;&#x7247;</button>
  </div>

  <div class="periodic-section">
    <div class="section-title">&#x1F4C8; &#x6570;&#x636E;&#x5468;&#x62A5;/&#x6708;&#x62A5;</div>
    <div class="period-tabs">
      <button class="period-tab active" onclick="switchPeriod('week')" id="periodTabWeek">&#x5468;&#x62A5;</button>
      <button class="period-tab" onclick="switchPeriod('month')" id="periodTabMonth">&#x6708;&#x62A5;</button>
    </div>
    <div id="periodicReport"></div>
  </div>
</div>

<!-- PAGE 3: Time Management -->
<div class="page" id="page-time">
  <div class="page-heading">&#x23F0; &#x65F6;&#x95F4;&#x7BA1;&#x7406;</div>
  <div class="time-top-row">
    <div class="card countdown-wrap">
      <div class="date-display" id="dateDisplay"></div>
      <div class="countdown-time" id="countdownTime">--:--:--</div>
      <div class="day-progress-wrap">
        <div class="day-ring">
          <canvas id="dayRingCanvas" width="44" height="44"></canvas>
          <div class="day-ring-pct" id="dayPct">0%</div>
        </div>
        <div class="day-progress-label">&#x4ECA;&#x65E5;&#x5DF2;&#x8FC7;</div>
      </div>
    </div>

    <div class="time-task-panel">
      <div class="quick-add-bar">
        <input class="quick-add-input" id="taskInput" placeholder="&#x6DFB;&#x52A0;&#x65B0;&#x4EFB;&#x52A1;..." maxlength="100">
        <div class="priority-sel">
          <button class="priority-opt p-high active" data-p="high" onclick="selectPriority('high')">&#x9AD8;</button>
          <button class="priority-opt p-med" data-p="med" onclick="selectPriority('med')">&#x4E2D;</button>
          <button class="priority-opt p-low" data-p="low" onclick="selectPriority('low')">&#x4F4E;</button>
        </div>
        <button class="add-btn" onclick="addTask()">+</button>
      </div>
      <div class="stats-bar" id="taskStats"></div>
    </div>
  </div>
  <div id="taskList"></div>
</div>

<!-- PAGE 4: Life Planning -->
<div class="page" id="page-life">
  <div class="page-heading">&#x1F31F; &#x4EBA;&#x751F;&#x89C4;&#x5212;</div>
  <div class="life-top-row">
    <div class="card remain-banner">
      <div style="font-size:14px;color:var(--text2);margin-bottom:4px">&#x9884;&#x8BA1;&#x5269;&#x4F59;</div>
      <div class="remain-years" id="remainYears">--</div>
      <div class="remain-label">&#x5E74;&#x7684;&#x7CBE;&#x5F69;&#x4EBA;&#x751F;</div>
    </div>

    <div class="card goal-progress-wrap">
      <div class="goal-ring">
        <canvas id="goalRingCanvas" width="60" height="60"></canvas>
        <div class="goal-ring-center" id="goalRingText">0/0</div>
      </div>
      <div class="goal-progress-text" id="goalProgressText">&#x5C1A;&#x672A;&#x8BBE;&#x5B9A;&#x4EBA;&#x751F;&#x76EE;&#x6807;</div>
    </div>
  </div>

  <div class="cat-filter" id="catFilter"></div>
  <div class="card life-timeline" id="lifeTimeline"><div class="timeline-bar"><div class="timeline-fill" id="timelineFill"></div></div></div>

  <div class="section-title">&#x1F3AF; &#x6211;&#x7684;&#x4EBA;&#x751F;&#x76EE;&#x6807;</div>
  <div class="goals-grid" id="goalList"></div>

  <div style="margin-top:16px;max-width:400px">
    <button class="btn btn-primary" onclick="openGoalModal()">+ &#x6DFB;&#x52A0;&#x65B0;&#x76EE;&#x6807;</button>
  </div>

  <div class="section-title">&#x26A1; &#x5FEB;&#x901F;&#x6DFB;&#x52A0;</div>
  <div class="preset-chips" id="presetChips"></div>
</div>
</div>

<!-- PAGE 5: Achievements -->
<div class="page" id="page-achievement">
  <div class="page-heading">&#x1F3C6; &#x6211;&#x7684;&#x6210;&#x5C31;</div>

  <!-- Level Card -->
  <div class="level-card" id="levelCard">
    <div class="level-icon" id="levelIcon">&#x1F331;</div>
    <div class="level-info">
      <div class="level-name" id="levelName">&#x521D;&#x884C;&#x8005;</div>
      <div class="level-lv" id="levelLv">Lv.1</div>
      <div class="level-points" id="levelPoints">0 &#x79EF;&#x5206;</div>
      <div class="level-progress"><div class="level-progress-fill" id="levelProgressFill" style="width:0%"></div></div>
      <div class="level-progress-text" id="levelProgressText">&#x8FD8;&#x9700; 100 &#x79EF;&#x5206;&#x5347;&#x7EA7;</div>
    </div>
  </div>

  <!-- Streak Card -->
  <div class="streak-card" id="streakCard">
    <div class="streak-header">
      <div class="streak-fire">&#x1F525;</div>
      <div>
        <div class="streak-count" id="streakCount">0</div>
        <div class="streak-label">&#x8FDE;&#x7EED;&#x6D3B;&#x8DC3;&#x5929;&#x6570;</div>
      </div>
    </div>
    <div class="streak-grid" id="streakGrid"></div>
  </div>

  <!-- Daily Challenges -->
  <div class="challenge-section">
    <div class="section-title">&#x1F3AF; &#x6BCF;&#x65E5;&#x6311;&#x6218;</div>
    <div class="challenge-cards" id="challengeCards"></div>
  </div>

  <!-- Medal Showcase -->
  <div class="medal-section">
    <div class="section-title">&#x1F3C5; &#x52CB;&#x7AE0;&#x5C55;&#x67DC;</div>
    <div class="medal-grid" id="medalGrid"></div>
  </div>

  <!-- Points Log -->
  <div class="points-log-section">
    <div class="section-title">&#x1F4DC; &#x6700;&#x8FD1;&#x52A8;&#x6001;</div>
    <div class="points-log" id="pointsLog"></div>
  </div>
</div>
</div>

<!-- Manual Entry Modal -->
<div class="modal-overlay" id="manualModal">
<div class="modal-sheet">
  <div class="modal-handle"></div>
  <div class="modal-title">&#x624B;&#x52A8;&#x5F55;&#x5165;&#x5065;&#x5EB7;&#x6570;&#x636E;</div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">&#x5E74;&#x9F84;</label><input class="form-input" id="f-age" type="number" placeholder="25"></div>
    <div class="form-group"><label class="form-label">&#x6027;&#x522B;</label><select class="form-input form-select" id="f-gender"><option value="">&#x8BF7;&#x9009;&#x62E9;</option><option value="male">&#x7537;</option><option value="female">&#x5973;</option></select></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">&#x8EAB;&#x9AD8; (cm)</label><input class="form-input" id="f-height" type="number" placeholder="170"></div>
    <div class="form-group"><label class="form-label">&#x4F53;&#x91CD; (kg)</label><input class="form-input" id="f-weight" type="number" placeholder="65" step="0.1"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">&#x6B65;&#x6570;</label><input class="form-input" id="f-steps" type="number" placeholder="8000"></div>
    <div class="form-group"><label class="form-label">&#x5FC3;&#x7387; (bpm)</label><input class="form-input" id="f-heartrate" type="number" placeholder="72"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">&#x6536;&#x7F29;&#x538B; (mmHg)</label><input class="form-input" id="f-systolic" type="number" placeholder="120"></div>
    <div class="form-group"><label class="form-label">&#x8212;&#x5F20;&#x538B; (mmHg)</label><input class="form-input" id="f-diastolic" type="number" placeholder="80"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">&#x8840;&#x7CD6; (mmol/L)</label><input class="form-input" id="f-glucose" type="number" placeholder="5.2" step="0.1"></div>
    <div class="form-group"><label class="form-label">&#x8840;&#x6C27; (%)</label><input class="form-input" id="f-oxygen" type="number" placeholder="98"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">&#x4F53;&#x6E29; (&#xB0;C)</label><input class="form-input" id="f-temp" type="number" placeholder="36.5" step="0.1"></div>
    <div class="form-group"><label class="form-label">&#x7761;&#x7720; (&#x5C0F;&#x65F6;)</label><input class="form-input" id="f-sleep" type="number" placeholder="7.5" step="0.1"></div>
  </div>
  <div class="form-group"><label class="form-label">&#x6BCF;&#x5468;&#x8FD0;&#x52A8; (&#x5206;&#x949F;)</label><input class="form-input" id="f-exercise" type="number" placeholder="150"></div>
  <div class="form-group">
    <label class="form-label">&#x662F;&#x5426;&#x5438;&#x70DF;</label>
    <div class="form-check-group" id="f-smoking">
      <button class="form-check" data-val="never">&#x4ECE;&#x4E0D;</button>
      <button class="form-check" data-val="quit">&#x5DF2;&#x6212;&#x70DF;</button>
      <button class="form-check" data-val="occasional">&#x5076;&#x5C14;</button>
      <button class="form-check" data-val="frequent">&#x7ECF;&#x5E38;</button>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">&#x996E;&#x9152;&#x9891;&#x7387;</label>
    <div class="form-check-group" id="f-alcohol">
      <button class="form-check" data-val="never">&#x4ECE;&#x4E0D;</button>
      <button class="form-check" data-val="occasional">&#x5076;&#x5C14;</button>
      <button class="form-check" data-val="frequent">&#x7ECF;&#x5E38;</button>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">&#x5BB6;&#x65CF;&#x75C5;&#x53F2; (&#x53EF;&#x591A;&#x9009;)</label>
    <div class="form-check-group" id="f-family">
      <button class="form-check" data-val="hypertension">&#x9AD8;&#x8840;&#x538B;</button>
      <button class="form-check" data-val="diabetes">&#x7CD6;&#x5C3F;&#x75C5;</button>
      <button class="form-check" data-val="heart">&#x5FC3;&#x810F;&#x75C5;</button>
      <button class="form-check" data-val="cancer">&#x764C;&#x75C7;</button>
      <button class="form-check" data-val="none">&#x65E0;</button>
    </div>
  </div>
  <button class="btn btn-primary" onclick="saveManualEntry()" style="margin-top:8px">&#x4FDD;&#x5B58;&#x6570;&#x636E;</button>
  <button class="btn btn-outline" onclick="closeManualEntry()" style="margin-top:8px;width:100%">&#x53D6;&#x6D88;</button>
</div>
</div>

<!-- Goal Modal -->
<div class="modal-overlay" id="goalModal">
<div class="modal-sheet">
  <div class="modal-handle"></div>
  <div class="modal-title">&#x6DFB;&#x52A0;&#x4EBA;&#x751F;&#x76EE;&#x6807;</div>
  <div class="form-group"><label class="form-label">&#x76EE;&#x6807;&#x540D;&#x79F0;</label><input class="form-input" id="g-title" placeholder="&#x4F8B;&#x5982;&#xFF1A;&#x73AF;&#x6E38;&#x4E16;&#x754C;" maxlength="50"></div>
  <div class="form-group"><label class="form-label">&#x7C7B;&#x522B;</label><select class="form-input form-select" id="g-cat">
    <option value="&#x65C5;&#x884C;">&#x1F30D; &#x65C5;&#x884C;</option><option value="&#x5B66;&#x4E60;">&#x1F4DA; &#x5B66;&#x4E60;</option><option value="&#x4E8B;&#x4E1A;">&#x1F4BC; &#x4E8B;&#x4E1A;</option><option value="&#x5BB6;&#x5EAD;">&#x1F3E0; &#x5BB6;&#x5EAD;</option><option value="&#x5065;&#x5EB7;">&#x1F4AA; &#x5065;&#x5EB7;</option><option value="&#x5192;&#x9669;">&#x1F3D4; &#x5192;&#x9669;</option><option value="&#x521B;&#x9020;">&#x1F3A8; &#x521B;&#x9020;</option><option value="&#x793E;&#x4EA4;">&#x1F91D; &#x793E;&#x4EA4;</option>
  </select></div>
  <div class="form-group"><label class="form-label">&#x76EE;&#x6807;&#x5E74;&#x9F84;</label><input class="form-input" id="g-age" type="number" placeholder="35"></div>
  <div class="form-group"><label class="form-label">&#x63CF;&#x8FF0;</label><input class="form-input" id="g-desc" placeholder="&#x7B80;&#x8981;&#x63CF;&#x8FF0;&#x8FD9;&#x4E2A;&#x76EE;&#x6807;..." maxlength="200"></div>
  <button class="btn btn-primary" onclick="saveGoal()" style="margin-top:8px">&#x6DFB;&#x52A0;&#x76EE;&#x6807;</button>
  <button class="btn btn-outline" onclick="closeGoalModal()" style="margin-top:8px;width:100%">&#x53D6;&#x6D88;</button>
</div>
</div>

<!-- Modals and Scripts moved outside #app to prevent display:none blocking -->
<script>
// Load Chart.js asynchronously so it never blocks login
(function(){
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js';
  s.async = true;
  s.onerror = function(){ console.log('Chart.js CDN failed to load - charts will be unavailable'); };
  document.head.appendChild(s);
})();
</script>
<script>
// Load html2canvas asynchronously for report image export
(function(){
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
  s.async = true;
  s.onerror = function(){ console.log('html2canvas CDN failed to load'); };
  document.head.appendChild(s);
})();
</script>
<script>
// ============================================================
// AUTH SYSTEM (Local verification code - no backend required)
// ============================================================
const LS_AUTH_USER = 'ln_auth_user';
let _currentCode = '';
let _currentCodePhone = '';

function getAuthUser() { try { return JSON.parse(localStorage.getItem(LS_AUTH_USER)); } catch(e) { return null; } }
function saveAuthUser(phone) {
  const masked = phone.substring(0,3) + '****' + phone.substring(7);
  localStorage.setItem(LS_AUTH_USER, JSON.stringify({ phone: masked, fullPhone: phone, loginTime: Date.now() }));
}
function clearAuth() { localStorage.removeItem(LS_AUTH_USER); }
function isValidPhone(phone) { return /^1[3-9]\d{9}$/.test(phone); }
function showAuthError(msg) {
  var el = document.getElementById('loginError');
  if (msg) {
    el.textContent = msg;
    el.style.color = '#E76F51';
    el.style.fontSize = '14px';
    el.style.fontWeight = '600';
    el.style.padding = '10px';
    el.style.maxHeight = '60px';
    el.style.overflow = 'visible';
    el.style.background = 'rgba(231,111,81,0.12)';
    el.style.borderRadius = '8px';
    el.style.marginTop = '12px';
  } else {
    el.textContent = '';
    el.style.cssText = '';
  }
}

function checkAuth() {
  const user = getAuthUser();
  if (user && user.phone) {
    hideAuthScreen();
  } else {
    showAuthScreen();
  }
}

function showAuthScreen() {
  var authEl = document.getElementById('authScreen');
  // Undo all inline styles
  authEl.style.display = '';
  authEl.style.visibility = '';
  authEl.style.opacity = '';
  authEl.style.pointerEvents = '';
  authEl.style.zIndex = '';
  authEl.classList.remove('auth-hidden', 'auth-gone');
  document.getElementById('app').style.display = 'none';
}

function hideAuthScreen() {
  var authEl = document.getElementById('authScreen');
  var appEl = document.getElementById('app');
  // Force hide auth screen using every method possible
  authEl.style.display = 'none';
  authEl.style.visibility = 'hidden';
  authEl.style.opacity = '0';
  authEl.style.pointerEvents = 'none';
  authEl.style.zIndex = '-1';
  authEl.classList.add('auth-hidden', 'auth-gone');
  // Force show app
  appEl.style.display = '';
  appEl.style.visibility = 'visible';
  appEl.style.opacity = '1';
  updateAuthUI();
  if (!window._appInitialized) {
    window._appInitialized = true;
    setTimeout(function() { if(typeof init === 'function') init(); }, 100);
  }
}

function updateAuthUI() {
  const user = getAuthUser();
  const header = document.querySelector('.app-header');
  if (!header) return;
  const existing = header.querySelectorAll('.auth-logout-btn,.auth-user-info');
  existing.forEach(e => e.remove());
  if (user && user.phone) {
    const info = document.createElement('span');
    info.className = 'auth-user-info';
    info.textContent = user.phone;
    header.appendChild(info);
    const btn = document.createElement('button');
    btn.className = 'auth-logout-btn';
    btn.textContent = '退出';
    btn.onclick = doLogout;
    header.appendChild(btn);
  }
}

function getLoginCode() {
  const phone = document.getElementById('loginPhone').value.trim();
  if (!isValidPhone(phone)) { showAuthError('请输入正确的11位手机号'); return; }

  // Generate random 6-digit code
  _currentCode = String(Math.floor(100000 + Math.random() * 900000));
  _currentCodePhone = phone;

  // Display the code to the user (code stays valid for 5 minutes)
  document.getElementById('codeDisplay').innerHTML = '您的验证码：<b style="color:var(--cyan);font-size:20px;letter-spacing:4px">' + _currentCode + '</b><br><span style="font-size:12px;color:var(--text3)">验证码5分钟内有效</span>';
  showAuthError('');

  // Auto-focus the code input
  document.getElementById('loginCode').focus();

  // Start 60s cooldown on BUTTON ONLY (code remains valid for 5 min)
  const btn = document.getElementById('loginSmsBtn');
  btn.disabled = true;
  let sec = 60;
  btn.textContent = sec + '秒';
  const btnTimer = setInterval(() => {
    sec--;
    btn.textContent = sec + '秒';
    if (sec <= 0) {
      clearInterval(btnTimer);
      btn.textContent = '重新获取';
      btn.disabled = false;
    }
  }, 1000);

  // Code expires after 5 minutes (separate from button cooldown)
  if (window._codeExpireTimer) clearTimeout(window._codeExpireTimer);
  window._codeExpireTimer = setTimeout(() => {
    if (_currentCode) {
      _currentCode = '';
      _currentCodePhone = '';
      document.getElementById('codeDisplay').innerHTML = '<span style="color:var(--coral);font-size:13px">验证码已过期，请重新获取</span>';
    }
  }, 5 * 60 * 1000);
}

function doLogin() {
  try {
    var phone = document.getElementById('loginPhone').value.trim();
    var code = document.getElementById('loginCode').value.trim();
    var btn = document.getElementById('loginSubmitBtn');

    if (!isValidPhone(phone)) { showAuthError('请输入正确的11位手机号'); return; }
    if (!code || code.length !== 6) { showAuthError('请输入6位验证码'); return; }
    if (!_currentCode || !_currentCodePhone) { showAuthError('请先获取验证码'); return; }
    if (phone !== _currentCodePhone) { showAuthError('手机号与获取验证码时不一致'); return; }
    if (code !== _currentCode) { showAuthError('验证码错误，请重新输入'); return; }

    // Verification passed - save and hide auth screen immediately
    saveAuthUser(phone);
    _currentCode = '';
    _currentCodePhone = '';
    if (window._codeExpireTimer) { clearTimeout(window._codeExpireTimer); window._codeExpireTimer = null; }
    document.getElementById('loginCode').value = '';
    document.getElementById('codeDisplay').textContent = '';
    btn.textContent = '登录成功';
    hideAuthScreen();
  } catch(err) {
    alert('登录出错: ' + err.message);
  }
}

// Allow Enter key to trigger login from code input
document.addEventListener('DOMContentLoaded', function() {
  var codeInput = document.getElementById('loginCode');
  if (codeInput) {
    codeInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); doLogin(); }
    });
  }
  var phoneInput = document.getElementById('loginPhone');
  if (phoneInput) {
    phoneInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); getLoginCode(); }
    });
  }
});

function doLogout() {
  clearAuth();
  window._appInitialized = false;
  document.getElementById('loginPhone').value = '';
  document.getElementById('loginCode').value = '';
  document.getElementById('codeDisplay').textContent = '';
  showAuthError('');
  showAuthScreen();
}

// ============================================================
// CAPACITOR / HEALTH CONNECT BRIDGE
// ============================================================
const isCapacitor = typeof window.Capacitor !== 'undefined';
let HealthConnectBridge = null;

// Register Capacitor plugin bridge
if (isCapacitor && window.Capacitor.Plugins) {
  HealthConnectBridge = window.Capacitor.Plugins.HealthConnect || null;
}
// Also try registering via Capacitor.registerPlugin for newer versions
if (!HealthConnectBridge && isCapacitor && window.Capacitor.registerPlugin) {
  try {
    HealthConnectBridge = window.Capacitor.registerPlugin('HealthConnect');
  } catch(e) { console.log('Health Connect plugin not available:', e); }
}

// Health Connect availability state
let healthConnectAvailable = false;
let healthConnectStatus = 'unknown'; // 'available', 'unavailable', 'update_required'

async function checkHealthConnectAvailability() {
  if (!HealthConnectBridge) {
    healthConnectStatus = 'not_native';
    return false;
  }
  try {
    const result = await HealthConnectBridge.checkAvailability();
    healthConnectAvailable = result.available;
    healthConnectStatus = result.status;
    return result.available;
  } catch(e) {
    console.log('Health Connect check failed:', e);
    healthConnectStatus = 'error';
    return false;
  }
}

async function requestHealthConnectPermissions() {
  if (!HealthConnectBridge) return false;
  try {
    const result = await HealthConnectBridge.requestHealthPermissions();
    return result.granted || result.requested;
  } catch(e) {
    console.log('Permission request failed:', e);
    return false;
  }
}

async function readHealthConnectData() {
  if (!HealthConnectBridge) return null;
  try {
    const result = await HealthConnectBridge.readHealthData();
    if (result.success) return result;
    return null;
  } catch(e) {
    console.log('Health data read failed:', e);
    return null;
  }
}

async function openHealthConnectSettings() {
  if (!HealthConnectBridge) return;
  try {
    await HealthConnectBridge.openHealthConnectApp();
  } catch(e) {
    console.log('Could not open Health Connect:', e);
  }
}

// Initialize Health Connect check on app start
if (isCapacitor) {
  document.addEventListener('DOMContentLoaded', () => {
    checkHealthConnectAvailability().then(() => {
      console.log('Health Connect status:', healthConnectStatus);
    });
    checkHuaweiHealthAvailability().then(() => {
      console.log('Huawei Health status:', huaweiHealthStatus);
    });
    // Re-render once all checks done
    setTimeout(() => renderDevices(), 1500);
  });
}

// ============================================================
// HUAWEI HEALTH BRIDGE
// ============================================================
let HuaweiHealthBridge = null;
let huaweiHealthAvailable = false;
let huaweiHealthStatus = 'unknown';

if (isCapacitor && window.Capacitor.Plugins) {
  HuaweiHealthBridge = window.Capacitor.Plugins.HuaweiHealth || null;
}
if (!HuaweiHealthBridge && isCapacitor && window.Capacitor.registerPlugin) {
  try {
    HuaweiHealthBridge = window.Capacitor.registerPlugin('HuaweiHealth');
  } catch(e) { console.log('Huawei Health plugin not available:', e); }
}

async function checkHuaweiHealthAvailability() {
  if (!HuaweiHealthBridge) {
    huaweiHealthStatus = 'not_native';
    return false;
  }
  try {
    const result = await HuaweiHealthBridge.checkAvailability();
    huaweiHealthAvailable = result.available;
    huaweiHealthStatus = result.status;
    return result.available;
  } catch(e) {
    console.log('Huawei Health check failed:', e);
    huaweiHealthStatus = 'error';
    return false;
  }
}

async function huaweiSignIn() {
  if (!HuaweiHealthBridge) return false;
  try {
    const result = await HuaweiHealthBridge.signIn();
    return result.success;
  } catch(e) {
    console.log('Huawei sign in failed:', e);
    return false;
  }
}

async function huaweiRequestAuth() {
  if (!HuaweiHealthBridge) return false;
  try {
    const result = await HuaweiHealthBridge.requestHealthAuth();
    return result.success;
  } catch(e) {
    console.log('Huawei health auth failed:', e);
    return false;
  }
}

async function readHuaweiHealthData() {
  if (!HuaweiHealthBridge) return null;
  try {
    const result = await HuaweiHealthBridge.readHealthData();
    if (result.success) return result;
    return null;
  } catch(e) {
    console.log('Huawei health data read failed:', e);
    return null;
  }
}

// ============================================================
// DATA LAYER
// ============================================================
const LS_HEALTH = 'ln_health_data';
const LS_HEALTH_HISTORY = 'ln_health_history';
const LS_TASKS = 'ln_tasks_';
const LS_GOALS = 'ln_goals';
const LS_DEVICES = 'ln_devices';

function loadData(key, def) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : def; } catch(e) { return def; } }
function saveData(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) {} }
function escHtml(s) { if(!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

let healthData = loadData(LS_HEALTH, {});
let healthHistory = loadData(LS_HEALTH_HISTORY, {});
let devices = loadData(LS_DEVICES, {});
let goals = loadData(LS_GOALS, []);

function todayKey() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function loadTasks() { return loadData(LS_TASKS + todayKey(), []); }
function saveTasks(t) { saveData(LS_TASKS + todayKey(), t); }

// ============================================================
// STARFIELD BACKGROUND
// ============================================================
(function initStarfield() {
  const c = document.getElementById('starfield');
  const ctx = c.getContext('2d');
  let dots = [];
  function resize() { c.width = window.innerWidth; c.height = window.innerHeight; dots = []; for(let i=0;i<60;i++) dots.push({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.5+0.5,speed:Math.random()*0.15+0.02,alpha:Math.random()*0.12+0.03}); }
  resize(); window.addEventListener('resize', resize);
  function draw() {
    ctx.clearRect(0,0,c.width,c.height);
    for(const s of dots) {
      s.y -= s.speed; if(s.y < -2) { s.y = c.height+2; s.x = Math.random()*c.width; }
      s.alpha += (Math.random()-0.5)*0.005; s.alpha = Math.max(0.02, Math.min(0.12, s.alpha));
      ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fillStyle = `rgba(180,150,120,${s.alpha})`; ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  draw();
})();

// ============================================================
// TAB NAVIGATION
// ============================================================
let currentTab = 0;
const pages = ['page-health','page-ai','page-time','page-life','page-achievement'];
function switchTab(idx) {
  if(idx === currentTab) return;
  if(window._tabSwitching) return;
  window._tabSwitching = true;
  setTimeout(function(){ window._tabSwitching = false; }, 300);

  // Clear countdown interval when leaving time tab
  if(currentTab === 2 && typeof countdownInterval !== 'undefined' && countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }

  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach((n,i) => n.classList.toggle('active', i===idx));
  const prev = document.getElementById(pages[currentTab]);
  const next = document.getElementById(pages[idx]);
  prev.classList.remove('active');
  prev.classList.add('exit-left');
  setTimeout(() => prev.classList.remove('exit-left'), 350);
  next.classList.add('active');
  currentTab = idx;
  if(typeof trackTabVisit === 'function') trackTabVisit(idx);
  if(idx === 1) refreshAITab();
  if(idx === 2) refreshTimeTab();
  if(idx === 3) refreshLifeTab();
  if(idx === 4) refreshAchievementTab();
}

// ============================================================
// TAB 1: HEALTH DATA
// ============================================================
const deviceList = [
  { id:'healthconnect', name:'Health Connect', icon:'💚', desc:'Google 健康数据平台' },
  { id:'apple', name:'Apple 健康', icon:'🍎', desc:'需要 iOS 设备' },
  { id:'huawei', name:'华为健康', icon:'📱', desc:'华为 Health Kit' },
  { id:'xiaomi', name:'小米穿戴', icon:'⌚', desc:'即将支持' },
  { id:'samsung', name:'Samsung Health', icon:'💙', desc:'即将支持' },
  { id:'google', name:'Google Fit', icon:'🏃', desc:'即将迁移至 Health Connect' },
  { id:'manual', name:'手动录入', icon:'✏️', desc:'直接输入健康数据' }
];

const metrics = [
  { key:'steps', label:'步数', unit:'步', icon:'👟', color:'var(--cyan)', range:[6000,10000] },
  { key:'heartrate', label:'心率', unit:'bpm', icon:'❤️', color:'var(--coral)', range:[60,100] },
  { key:'glucose', label:'血糖', unit:'mmol/L', icon:'💧', color:'var(--gold)', range:[3.9,6.1] },
  { key:'systolic', label:'血压', unit:'mmHg', icon:'🩺', color:'var(--purple)', range:[90,140], subkey:'diastolic', subunit:'/mmHg' },
  { key:'sleep', label:'睡眠', unit:'小时', icon:'🌙', color:'var(--lavender)', range:[7,9] },
  { key:'weight', label:'体重', unit:'kg', icon:'⚖️', color:'var(--green)', range:[50,80] },
  { key:'temp', label:'体温', unit:'°C', icon:'🌡️', color:'var(--orange)', range:[36.0,37.2] },
  { key:'oxygen', label:'血氧', unit:'%', icon:'🫁', color:'var(--blue)', range:[95,100] }
];

function renderDevices() {
  const wrap = document.getElementById('deviceScroll');
  wrap.innerHTML = deviceList.map(d => {
    const connected = devices[d.id];
    const cls = connected ? 'device-card connected' : 'device-card';
    let statusText = '';
    let btnText = '';
    let onclick = '';
    let disabled = false;

    if (d.id === 'manual') {
      statusText = '';
      btnText = '录入';
      onclick = 'openManualEntry()';
    } else if (d.id === 'healthconnect') {
      if (connected) {
        statusText = `<span style="color:var(--green)">● 已同步</span>`;
        btnText = '重新同步';
        onclick = `connectHealthConnect()`;
      } else if (isCapacitor && healthConnectAvailable) {
        statusText = `<span style="color:var(--cyan)">● 可用</span>`;
        btnText = '连接';
        onclick = `connectHealthConnect()`;
      } else if (isCapacitor && healthConnectStatus === 'update_required') {
        statusText = `<span style="color:var(--gold)">需更新</span>`;
        btnText = '安装';
        onclick = `openHealthConnectSettings()`;
      } else if (!isCapacitor) {
        statusText = `<span style="color:var(--text2)">需安装APP</span>`;
        btnText = '仅APK';
        disabled = true;
      } else {
        statusText = `<span style="color:var(--text2)">不可用</span>`;
        btnText = '安装';
        onclick = `openHealthConnectSettings()`;
      }
    } else if (d.id === 'apple') {
      statusText = `<span style="color:var(--text2)">仅iOS</span>`;
      btnText = '暂不支持';
      disabled = true;
    } else if (d.id === 'huawei') {
      if (connected) {
        statusText = `<span style="color:var(--green)">● 已同步</span>`;
        btnText = '重新同步';
        onclick = `connectHuaweiHealth()`;
      } else if (isCapacitor && huaweiHealthAvailable) {
        statusText = `<span style="color:var(--cyan)">● 可用</span>`;
        btnText = '连接';
        onclick = `connectHuaweiHealth()`;
      } else if (!isCapacitor) {
        statusText = `<span style="color:var(--text2)">需安装APP</span>`;
        btnText = '仅APK';
        disabled = true;
      } else if (huaweiHealthStatus === 'not_native') {
        statusText = `<span style="color:var(--text2)">不可用</span>`;
        btnText = '仅华为设备';
        disabled = true;
      } else {
        statusText = `<span style="color:var(--text2)">HMS不可用</span>`;
        btnText = '不可用';
        disabled = true;
      }
    } else if (['xiaomi','samsung','google'].includes(d.id)) {
      if (connected) {
        statusText = `<span style="color:var(--green)">● 已连接</span>`;
        btnText = '已同步';
      } else {
        statusText = `<span style="color:var(--text3)">开发中</span>`;
        btnText = '即将上线';
        disabled = true;
      }
    } else {
      if (connected) {
        statusText = `<span style="color:var(--green)">● 已连接</span>`;
        btnText = '已同步';
      } else {
        btnText = '连接';
        onclick = `connectDevice('${d.id}')`;
      }
    }

    const disabledAttr = disabled ? 'disabled style="opacity:0.5;cursor:not-allowed"' : '';
    const descLine = d.desc ? `<div style="font-size:10px;color:var(--text3);margin-top:2px">${d.desc}</div>` : '';
    return `<div class="${cls}" id="dev-${d.id}"><div class="dev-icon">${d.icon}</div><div class="dev-name">${d.name}${descLine}</div><div class="dev-status">${statusText}</div><button class="sync-btn" onclick="${onclick}" ${disabledAttr}>${btnText}</button></div>`;
  }).join('');
}

// Health Connect native bridge connection
async function connectHealthConnect() {
  const card = document.getElementById('dev-healthconnect');
  if (!card) return;
  card.classList.add('connecting');
  const btn = card.querySelector('.sync-btn');
  const status = card.querySelector('.dev-status');
  btn.textContent = '连接中...';

  try {
    // Step 1: Check availability
    if (!healthConnectAvailable) {
      const avail = await checkHealthConnectAvailability();
      if (!avail) {
        status.innerHTML = `<span style="color:var(--coral)">不可用</span>`;
        btn.textContent = '安装';
        btn.onclick = () => openHealthConnectSettings();
        card.classList.remove('connecting');
        return;
      }
    }

    // Step 2: Request permissions
    status.innerHTML = `<span style="color:var(--gold)">请求权限...</span>`;
    await requestHealthConnectPermissions();

    // Step 3: Read health data
    status.innerHTML = `<span style="color:var(--cyan)">读取数据...</span>`;
    const data = await readHealthConnectData();

    if (data && data.success) {
      // Apply real health data
      const realData = {};
      if (data.steps !== undefined) realData.steps = data.steps;
      if (data.heartrate !== undefined) realData.heartrate = data.heartrate;
      if (data.glucose !== undefined) realData.glucose = data.glucose;
      if (data.systolic !== undefined) realData.systolic = data.systolic;
      if (data.diastolic !== undefined) realData.diastolic = data.diastolic;
      if (data.sleep !== undefined) realData.sleep = data.sleep;
      if (data.weight !== undefined) realData.weight = data.weight;
      if (data.temp !== undefined) realData.temp = data.temp;
      if (data.oxygen !== undefined) realData.oxygen = data.oxygen;

      Object.assign(healthData, realData);
      if (!healthData.age) healthData.age = 30;
      if (!healthData.gender) healthData.gender = 'male';
      if (!healthData.height) healthData.height = 170;
      if (!healthData.exercise) healthData.exercise = 120;
      if (!healthData.smoking) healthData.smoking = 'never';
      if (!healthData.alcohol) healthData.alcohol = 'occasional';
      if (!healthData.family) healthData.family = [];
      saveData(LS_HEALTH, healthData);
      addToHistory(realData);

      devices['healthconnect'] = { time: new Date().toISOString(), source: 'health_connect' };
      saveData(LS_DEVICES, devices);

      card.classList.remove('connecting');
      card.classList.add('connected');
      const count = Object.keys(realData).length;
      status.innerHTML = `<span style="color:var(--green)">● 已同步 ${count} 项数据</span>`;
      btn.textContent = '重新同步';
      renderMetrics();
      addPoints(20, '同步健康数据');
      updateStreak();
      checkDailyChallenge('record_health');

      // Show success toast
      showToast(`已从 Health Connect 同步 ${count} 项健康数据`);
    } else {
      // No data available - might need permissions
      status.innerHTML = `<span style="color:var(--gold)">无数据或需授权</span>`;
      btn.textContent = '授权并重试';
      card.classList.remove('connecting');
      showToast('未获取到数据，请在 Health Connect 中授权本应用');
    }
  } catch(e) {
    console.error('Health Connect error:', e);
    status.innerHTML = `<span style="color:var(--coral)">连接失败</span>`;
    btn.textContent = '重试';
    card.classList.remove('connecting');
    showToast('Health Connect 连接失败: ' + (e.message || '未知错误'));
  }
}

// Huawei Health native bridge connection
async function connectHuaweiHealth() {
  const card = document.getElementById('dev-huawei');
  if (!card) return;
  card.classList.add('connecting');
  const btn = card.querySelector('.sync-btn');
  const status = card.querySelector('.dev-status');
  btn.textContent = '连接中...';

  try {
    // Step 1: Check availability
    if (!huaweiHealthAvailable) {
      await checkHuaweiHealthAvailability();
      if (!huaweiHealthAvailable) {
        status.innerHTML = `<span style="color:var(--coral)">HMS不可用</span>`;
        btn.textContent = '不可用';
        card.classList.remove('connecting');
        return;
      }
    }

    // Step 2: Sign in with Huawei ID
    status.innerHTML = `<span style="color:var(--gold)">华为账号登录...</span>`;
    const signInResult = await huaweiSignIn();
    if (!signInResult) {
      status.innerHTML = `<span style="color:var(--coral)">登录失败</span>`;
      btn.textContent = '重试';
      card.classList.remove('connecting');
      showToast('华为账号登录失败，请重试');
      return;
    }

    // Step 3: Request health data authorization
    status.innerHTML = `<span style="color:var(--gold)">请求健康授权...</span>`;
    const authResult = await huaweiRequestAuth();
    if (!authResult) {
      status.innerHTML = `<span style="color:var(--coral)">授权失败</span>`;
      btn.textContent = '重试';
      card.classList.remove('connecting');
      showToast('健康数据授权失败，请在弹窗中允许授权');
      return;
    }

    // Step 4: Read health data
    status.innerHTML = `<span style="color:var(--cyan)">读取数据...</span>`;
    const data = await readHuaweiHealthData();

    if (data && data.success) {
      const realData = {};
      if (data.steps !== undefined) realData.steps = data.steps;
      if (data.heartrate !== undefined) realData.heartrate = data.heartrate;
      if (data.glucose !== undefined) realData.glucose = data.glucose;
      if (data.systolic !== undefined) realData.systolic = data.systolic;
      if (data.diastolic !== undefined) realData.diastolic = data.diastolic;
      if (data.sleep !== undefined) realData.sleep = data.sleep;
      if (data.weight !== undefined) realData.weight = data.weight;
      if (data.temp !== undefined) realData.temp = data.temp;
      if (data.oxygen !== undefined) realData.oxygen = data.oxygen;

      Object.assign(healthData, realData);
      if (!healthData.age) healthData.age = 30;
      if (!healthData.gender) healthData.gender = 'male';
      if (!healthData.height) healthData.height = 170;
      if (!healthData.exercise) healthData.exercise = 120;
      if (!healthData.smoking) healthData.smoking = 'never';
      if (!healthData.alcohol) healthData.alcohol = 'occasional';
      if (!healthData.family) healthData.family = [];
      saveData(LS_HEALTH, healthData);
      addToHistory(realData);

      devices['huawei'] = { time: new Date().toISOString(), source: 'huawei_health' };
      saveData(LS_DEVICES, devices);

      card.classList.remove('connecting');
      card.classList.add('connected');
      const count = Object.keys(realData).length;
      status.innerHTML = `<span style="color:var(--green)">● 已同步 ${count} 项数据</span>`;
      btn.textContent = '重新同步';
      renderMetrics();
      addPoints(20, '同步健康数据');
      updateStreak();
      checkDailyChallenge('record_health');
      showToast(`已从华为健康同步 ${count} 项健康数据`);
    } else {
      status.innerHTML = `<span style="color:var(--gold)">无数据或需授权</span>`;
      btn.textContent = '重试';
      card.classList.remove('connecting');
      showToast('未获取到数据，请确认华为健康中有数据且已授权');
    }
  } catch(e) {
    console.error('Huawei Health error:', e);
    status.innerHTML = `<span style="color:var(--coral)">连接失败</span>`;
    btn.textContent = '重试';
    card.classList.remove('connecting');
    showToast('华为健康连接失败: ' + (e.message || '未知错误'));
  }
}

// Toast notification helper
function showToast(msg) {
  let toast = document.getElementById('app-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'app-toast';
    toast.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg);padding:10px 20px;border-radius:20px;font-size:13px;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;max-width:80%;text-align:center';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 3000);
}

// Legacy simulated connection for non-Health-Connect devices (placeholder)
function connectDevice(id) {
  // For non-Health-Connect devices, show coming-soon message
  showToast(`${id} 接口正在开发中，请使用 Health Connect 或手动录入`);
}

function addToHistory(data) {
  const today = todayKey();
  for(const k of Object.keys(data)) {
    if(!healthHistory[k]) healthHistory[k] = [];
    healthHistory[k].push({ date: today, value: data[k] });
    if(healthHistory[k].length > 30) healthHistory[k] = healthHistory[k].slice(-30);
  }
  saveData(LS_HEALTH_HISTORY, healthHistory);
}

function getSparklineData(key) {
  const hist = healthHistory[key] || [];
  if(hist.length >= 2) return hist.slice(-14).map(h => h.value);
  // Generate fake 7-day data
  const base = healthData[key] || metrics.find(m=>m.key===key)?.range[0] || 50;
  const arr = [];
  for(let i=0;i<7;i++) arr.push(base * (0.9 + Math.random()*0.2));
  return arr;
}

function getTrend(key) {
  const data = getSparklineData(key);
  if(data.length < 2) return 'stable';
  const last = data[data.length-1], prev = data[data.length-2];
  const diff = (last - prev) / (prev || 1);
  if(diff > 0.02) return 'up';
  if(diff < -0.02) return 'down';
  return 'stable';
}

function drawSparkline(canvasId, data, color) {
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.parentElement.offsetWidth;
  const h = canvas.height = 32;
  ctx.clearRect(0,0,w,h);
  if(data.length < 2) return;
  const min = Math.min(...data)*0.95, max = Math.max(...data)*1.05;
  const range = max - min || 1;
  const step = w / (data.length - 1);
  const points = data.map((v,i) => ({ x: i*step, y: h - ((v-min)/range)*h*0.85 - h*0.05 }));
  // Gradient fill - resolve color safely
  function colorWithAlpha(c, alpha) {
    var tmp = document.createElement('canvas').getContext('2d');
    tmp.fillStyle = c;
    var resolved = tmp.fillStyle; // always #rrggbb or rgb(...)
    if(resolved.startsWith('#')) {
      var r = parseInt(resolved.slice(1,3),16), g = parseInt(resolved.slice(3,5),16), b = parseInt(resolved.slice(5,7),16);
      return 'rgba('+r+','+g+','+b+','+alpha+')';
    }
    return resolved.replace('rgb','rgba').replace(')',','+alpha+')');
  }
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0, colorWithAlpha(color, 0.3));
  grad.addColorStop(1, 'rgba(0,0,0,0)');
  // Parse CSS color
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for(let i=1;i<points.length;i++) {
    const prev = points[i-1], curr = points[i];
    const cpx1 = prev.x + step*0.4, cpx2 = curr.x - step*0.4;
    ctx.bezierCurveTo(cpx1, prev.y, cpx2, curr.y, curr.x, curr.y);
  }
  // Fill
  ctx.lineTo(points[points.length-1].x, h);
  ctx.lineTo(points[0].x, h);
  ctx.closePath();
  ctx.fillStyle = 'rgba(120,90,60,0.06)';
  ctx.fill();
  // Line
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for(let i=1;i<points.length;i++) {
    const prev = points[i-1], curr = points[i];
    const cpx1 = prev.x + step*0.4, cpx2 = curr.x - step*0.4;
    ctx.bezierCurveTo(cpx1, prev.y, cpx2, curr.y, curr.x, curr.y);
  }
  ctx.strokeStyle = getCSSColor(color);
  ctx.lineWidth = 1.5;
  ctx.stroke();
  // End dot
  const last = points[points.length-1];
  ctx.beginPath();
  ctx.arc(last.x, last.y, 2.5, 0, Math.PI*2);
  ctx.fillStyle = getCSSColor(color);
  ctx.fill();
}

function getCSSColor(c) {
  const map = {'var(--cyan)':'#2A9D8F','var(--coral)':'#E76F51','var(--gold)':'#E9A820','var(--green)':'#40916C','var(--purple)':'#7B68A8','var(--lavender)':'#9381BE','var(--orange)':'#E07A3A','var(--blue)':'#4A8FBF'};
  return map[c] || c;
}

function renderMetrics() {
  const grid = document.getElementById('metricsGrid');
  grid.innerHTML = metrics.map((m,i) => {
    const val = healthData[m.key];
    const displayVal = val !== undefined ? val : '--';
    const trend = val !== undefined ? getTrend(m.key) : 'stable';
    const trendIcon = trend === 'up' ? '↑' : trend === 'down' ? '↓' : '→';
    const trendColor = m.key === 'steps' || m.key === 'oxygen' ? (trend === 'up' ? 'var(--green)' : trend === 'down' ? 'var(--coral)' : 'var(--text3)') : (trend === 'down' ? 'var(--green)' : trend === 'up' ? 'var(--coral)' : 'var(--text3)');
    let valDisplay = `${displayVal}<span class="metric-unit">${m.unit}</span>`;
    if(m.subkey && healthData[m.subkey] !== undefined) {
      valDisplay = `${displayVal}/${healthData[m.subkey]}<span class="metric-unit">${m.unit}</span>`;
    }
    const now = new Date();
    const timeStr = val !== undefined ? `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')} 更新` : '';
    return `<div class="card metric-card">
      <div class="metric-header">
        <div class="metric-icon" style="background:${getCSSColor(m.color)}22">${m.icon}</div>
        <div class="metric-trend" style="color:${trendColor}">${trendIcon}</div>
      </div>
      <div class="metric-value" style="color:${getCSSColor(m.color)}">${valDisplay}</div>
      <div class="metric-label">${m.label}</div>
      <div class="sparkline-wrap"><canvas id="spark-${m.key}"></canvas></div>
      <div class="metric-time">${timeStr}</div>
    </div>`;
  }).join('');
  // Draw sparklines after DOM update
  requestAnimationFrame(() => {
    metrics.forEach(m => {
      if(healthData[m.key] !== undefined) {
        drawSparkline('spark-' + m.key, getSparklineData(m.key), m.color);
      }
    });
  });
}

// Manual Entry
function openManualEntry() {
  document.getElementById('manualModal').classList.add('show');
  // Populate form with existing data
  const fields = ['age','gender','height','weight','steps','heartrate','systolic','diastolic','glucose','oxygen','temp','sleep','exercise'];
  fields.forEach(f => {
    const el = document.getElementById('f-' + f);
    if(el && healthData[f] !== undefined) el.value = healthData[f];
  });
  // Set check groups
  if(healthData.smoking) {
    document.querySelectorAll('#f-smoking .form-check').forEach(b => b.classList.toggle('selected', b.dataset.val === healthData.smoking));
  }
  if(healthData.alcohol) {
    document.querySelectorAll('#f-alcohol .form-check').forEach(b => b.classList.toggle('selected', b.dataset.val === healthData.alcohol));
  }
  if(healthData.family) {
    document.querySelectorAll('#f-family .form-check').forEach(b => b.classList.toggle('selected', healthData.family.includes(b.dataset.val)));
  }
}
function closeManualEntry() { document.getElementById('manualModal').classList.remove('show'); }

// Check group handlers
document.querySelectorAll('#f-smoking .form-check').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('#f-smoking .form-check').forEach(x => x.classList.remove('selected'));
    b.classList.add('selected');
  });
});
document.querySelectorAll('#f-alcohol .form-check').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('#f-alcohol .form-check').forEach(x => x.classList.remove('selected'));
    b.classList.add('selected');
  });
});
document.querySelectorAll('#f-family .form-check').forEach(b => {
  b.addEventListener('click', () => {
    if(b.dataset.val === 'none') {
      document.querySelectorAll('#f-family .form-check').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected');
    } else {
      document.querySelector('#f-family .form-check[data-val="none"]')?.classList.remove('selected');
      b.classList.toggle('selected');
    }
  });
});

function saveManualEntry() {
  // Validation ranges
  const ranges = {age:[1,150],height:[30,300],weight:[2,500],steps:[0,200000],heartrate:[20,250],systolic:[50,300],diastolic:[30,200],glucose:[1,35],oxygen:[50,100],temp:[30,45],sleep:[0,24],exercise:[0,2000]};
  const fields = {age:'f-age',gender:'f-gender',height:'f-height',weight:'f-weight',steps:'f-steps',heartrate:'f-heartrate',systolic:'f-systolic',diastolic:'f-diastolic',glucose:'f-glucose',oxygen:'f-oxygen',temp:'f-temp',sleep:'f-sleep',exercise:'f-exercise'};
  const fieldNames = {age:'年龄',height:'身高',weight:'体重',steps:'步数',heartrate:'心率',systolic:'收缩压',diastolic:'舒张压',glucose:'血糖',oxygen:'血氧',temp:'体温',sleep:'睡眠',exercise:'运动'};
  const numFields = ['age','height','weight','steps','heartrate','systolic','diastolic','glucose','oxygen','temp','sleep','exercise'];

  // Validate ranges
  for(const [k,id] of Object.entries(fields)) {
    const el = document.getElementById(id);
    if(el && el.value && numFields.includes(k)) {
      const v = parseFloat(el.value);
      const r = ranges[k];
      if(r && (isNaN(v) || v < r[0] || v > r[1])) {
        alert((fieldNames[k]||k) + '的合理范围为 ' + r[0] + '-' + r[1] + '，请检查输入');
        el.focus();
        return;
      }
    }
  }

  for(const [k,id] of Object.entries(fields)) {
    const el = document.getElementById(id);
    if(el && el.value) {
      healthData[k] = numFields.includes(k) ? parseFloat(el.value) : el.value;
    }
  }
  const smokingSel = document.querySelector('#f-smoking .form-check.selected');
  if(smokingSel) healthData.smoking = smokingSel.dataset.val;
  const alcoholSel = document.querySelector('#f-alcohol .form-check.selected');
  if(alcoholSel) healthData.alcohol = alcoholSel.dataset.val;
  const familySel = [...document.querySelectorAll('#f-family .form-check.selected')].map(b => b.dataset.val);
  healthData.family = familySel.includes('none') ? [] : familySel;

  saveData(LS_HEALTH, healthData);
  addToHistory({steps:healthData.steps,heartrate:healthData.heartrate,glucose:healthData.glucose,systolic:healthData.systolic,diastolic:healthData.diastolic,sleep:healthData.sleep,weight:healthData.weight,temp:healthData.temp,oxygen:healthData.oxygen});
  closeManualEntry();
  renderMetrics();
  addPoints(20, '录入健康数据');
  updateStreak();
  checkDailyChallenge('record_health');
  localStorage.setItem('ln_onboarding_done','1');
  dismissOnboarding();
}
// ============================================================
// TAB 2: AI ANALYSIS - Prediction Algorithm
// ============================================================
function calcPrediction() {
  const d = healthData;
  if(!d.age || !d.gender) return null;

  let base = d.gender === 'female' ? 81 : 76;

  // BMI
  let bmi = null;
  if(d.height && d.weight) {
    bmi = d.weight / ((d.height/100)**2);
    if(bmi >= 18.5 && bmi <= 23.9) base += 2;
    else if(bmi >= 24 && bmi <= 27.9) base -= 1;
    else if(bmi >= 28) base -= 3;
    else if(bmi < 18.5) base -= 1;
  }

  // Exercise
  const ex = d.exercise || 0;
  if(ex < 60) base -= 3;
  else if(ex < 150) base -= 1;
  else if(ex <= 300) base += 2;
  else base += 3;

  // Smoking
  const smokingMap = {never:0, quit:-1, occasional:-3, frequent:-7};
  base += smokingMap[d.smoking] || 0;

  // Alcohol
  const alcoholMap = {never:0, occasional:-0.5, frequent:-4};
  base += alcoholMap[d.alcohol] || 0;

  // Blood pressure
  const sys = d.systolic || 120;
  if(sys < 120) base += 1;
  else if(sys < 130) base -= 0;
  else if(sys < 140) base -= 1;
  else if(sys < 160) base -= 3;
  else base -= 5;

  // Blood glucose
  const glu = d.glucose || 5.0;
  if(glu < 6.1) base += 1;
  else if(glu < 7.0) base -= 2;
  else base -= 5;

  // Sleep
  const sl = d.sleep || 7;
  if(sl >= 7 && sl <= 8) base += 1;
  else if((sl >= 6 && sl < 7) || (sl > 8 && sl <= 9)) base += 0;
  else base -= 2;

  // Heart rate
  const hr = d.heartrate || 72;
  if(hr >= 60 && hr <= 80) base += 1;
  else if((hr >= 50 && hr < 60) || (hr > 80 && hr <= 90)) base += 0;
  else base -= 2;

  // Blood oxygen
  const ox = d.oxygen || 98;
  if(ox > 95) base += 0;
  else if(ox >= 90) base -= 1;
  else base -= 3;

  // Family history
  const fam = d.family || [];
  base -= fam.length;

  // Age adjustment: younger people benefit more
  const ageAdj = Math.max(0, (50 - d.age) / 50) * 1.5;
  base += ageAdj;

  const remaining = Math.max(1, Math.round(base - d.age));
  const predicted = d.age + remaining;
  const low = predicted - 4;
  const high = predicted + 4;

  return { predicted, remaining, low, high, bmi, base };
}

function calcHealthScore() {
  const d = healthData;
  if(!d.age) return { total:0, cardio:0, metabolic:0, fitness:0, sleepQ:0, lifestyle:0 };

  // Cardiovascular (BP, HR, exercise, smoking)
  let cardio = 80;
  const sys = d.systolic || 120;
  if(sys < 120) cardio += 15; else if(sys < 130) cardio += 5; else if(sys < 140) cardio -= 5; else cardio -= 20;
  const hr = d.heartrate || 72;
  if(hr >= 60 && hr <= 80) cardio += 5; else if(hr > 100 || hr < 50) cardio -= 15;
  if(d.smoking === 'frequent') cardio -= 20; else if(d.smoking === 'occasional') cardio -= 10;
  if((d.exercise||0) >= 150) cardio += 5; else if((d.exercise||0) < 60) cardio -= 10;
  cardio = Math.max(0, Math.min(100, cardio));

  // Metabolic (glucose, BMI, BP)
  let metabolic = 80;
  const glu = d.glucose || 5.0;
  if(glu < 6.1) metabolic += 10; else if(glu < 7.0) metabolic -= 10; else metabolic -= 25;
  if(d.height && d.weight) {
    const bmi = d.weight / ((d.height/100)**2);
    if(bmi >= 18.5 && bmi <= 23.9) metabolic += 10; else if(bmi >= 28) metabolic -= 15; else if(bmi >= 24) metabolic -= 5;
  }
  metabolic = Math.max(0, Math.min(100, metabolic));

  // Fitness (exercise, steps, HR)
  let fitness = 60;
  const ex = d.exercise || 0;
  if(ex >= 300) fitness += 30; else if(ex >= 150) fitness += 20; else if(ex >= 60) fitness += 5; else fitness -= 10;
  const steps = d.steps || 0;
  if(steps >= 10000) fitness += 10; else if(steps >= 7000) fitness += 5; else if(steps < 3000) fitness -= 10;
  fitness = Math.max(0, Math.min(100, fitness));

  // Sleep quality
  let sleepQ = 70;
  const sl = d.sleep || 7;
  if(sl >= 7 && sl <= 8) sleepQ += 25; else if(sl >= 6 && sl <= 9) sleepQ += 10; else sleepQ -= 15;
  sleepQ = Math.max(0, Math.min(100, sleepQ));

  // Lifestyle (smoking, alcohol, exercise)
  let lifestyle = 80;
  if(d.smoking === 'frequent') lifestyle -= 30; else if(d.smoking === 'occasional') lifestyle -= 15; else if(d.smoking === 'quit') lifestyle -= 5;
  if(d.alcohol === 'frequent') lifestyle -= 20; else if(d.alcohol === 'occasional') lifestyle -= 5;
  if(ex >= 150) lifestyle += 10;
  lifestyle = Math.max(0, Math.min(100, lifestyle));

  const total = Math.round((cardio*0.25 + metabolic*0.2 + fitness*0.2 + sleepQ*0.15 + lifestyle*0.2));
  return { total, cardio: Math.round(cardio), metabolic: Math.round(metabolic), fitness: Math.round(fitness), sleepQ: Math.round(sleepQ), lifestyle: Math.round(lifestyle) };
}

function drawRing(canvasId, pct, color, lineWidth, size) {
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = size || canvas.width;
  canvas.width = w; canvas.height = w;
  const cx = w/2, cy = w/2, r = w/2 - lineWidth;
  ctx.clearRect(0,0,w,w);
  // Background
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(120,90,60,0.08)'; ctx.lineWidth = lineWidth; ctx.stroke();
  // Fill
  if(pct > 0) {
    ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+Math.PI*2*Math.min(pct,1));
    ctx.strokeStyle = color; ctx.lineWidth = lineWidth; ctx.lineCap = 'round'; ctx.stroke();
  }
}

let lifeClockAngle = 0;
function drawLifeClock(pred) {
  const canvas = document.getElementById('lifeClockCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = 180;
  canvas.width = w; canvas.height = w;
  const cx = w/2, cy = w/2;
  ctx.clearRect(0,0,w,w);

  // Outer ring bg
  ctx.beginPath(); ctx.arc(cx,cy,82,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(120,90,60,0.06)'; ctx.lineWidth = 8; ctx.stroke();

  if(!pred) return;

  lifeClockAngle = (lifeClockAngle + 0.003) % (Math.PI * 2);
  const pct = healthData.age / pred.predicted;
  const startAngle = -Math.PI/2 + lifeClockAngle;

  // Gradient ring
  const grad = ctx.createConicGradient(startAngle, cx, cy);
  grad.addColorStop(0, '#2A9D8F'); grad.addColorStop(0.3, '#7B68A8'); grad.addColorStop(0.6, '#E76F51'); grad.addColorStop(1, '#2A9D8F');
  ctx.beginPath(); ctx.arc(cx,cy,82,startAngle,startAngle+Math.PI*2*pct);
  ctx.strokeStyle = grad; ctx.lineWidth = 8; ctx.lineCap = 'round'; ctx.stroke();

  // Tick marks
  for(let i=0;i<60;i++) {
    const angle = (i/60)*Math.PI*2 - Math.PI/2;
    const inner = i%5===0 ? 68 : 72;
    const outer = 76;
    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(angle)*inner, cy + Math.sin(angle)*inner);
    ctx.lineTo(cx + Math.cos(angle)*outer, cy + Math.sin(angle)*outer);
    ctx.strokeStyle = i%5===0 ? 'rgba(58,48,40,0.15)' : 'rgba(58,48,40,0.05)';
    ctx.lineWidth = i%5===0 ? 1.5 : 0.5;
    ctx.stroke();
  }
}

function refreshAITab() {
  const pred = calcPrediction();
  const score = calcHealthScore();

  var el1 = document.getElementById('lifeClockYears');
  var el2 = document.getElementById('lifeExpectText');
  if(pred) {
    if(el1) el1.textContent = pred.remaining;
    if(el2) el2.textContent = `预期寿命: ${pred.low}-${pred.high} 岁`;
    drawLifeClock(pred);
  } else {
    if(el1) el1.textContent = '--';
    if(el2) el2.textContent = '请先录入健康数据';
    drawLifeClock(null);
  }

  // Score
  const scoreColor = score.total > 75 ? 'var(--green)' : score.total > 50 ? 'var(--gold)' : 'var(--coral)';
  var scoreEl = document.getElementById('scoreValue');
  if(scoreEl) { scoreEl.textContent = score.total || '--'; scoreEl.style.color = getCSSColor(scoreColor); }
  drawRing('scoreRingCanvas', score.total/100, getCSSColor(scoreColor), 6, 90);

  // Sub-scores
  const subs = [
    {name:'心血管健康', val:score.cardio, color:'var(--coral)'},
    {name:'代谢健康', val:score.metabolic, color:'var(--gold)'},
    {name:'运动体能', val:score.fitness, color:'var(--green)'},
    {name:'睡眠质量', val:score.sleepQ, color:'var(--lavender)'},
    {name:'生活习惯', val:score.lifestyle, color:'var(--cyan)'}
  ];
  document.getElementById('scoreBars').innerHTML = subs.map(s =>
    `<div class="score-bar-item"><div class="score-bar-name">${s.name}</div><div class="score-bar-track"><div class="score-bar-fill" style="width:${s.val}%;background:${getCSSColor(s.color)}"></div></div><div class="score-bar-val">${s.val}</div></div>`
  ).join('');
}
// ============================================================
// TAB 2: REPORT GENERATION
// ============================================================
function generateReport() {
  const d = healthData;
  if(!d.age || !d.gender) {
    alert('请先录入基本健康数据（至少需要年龄和性别）');
    return;
  }
  document.getElementById('genReportBtn').classList.add('hidden');
  document.getElementById('analyzingWrap').classList.remove('hidden');
  document.getElementById('reportContainer').classList.add('hidden');
  document.getElementById('reportActions').classList.add('hidden');

  const stages = ['采集数据...','分析指标...','生成报告...'];
  let si = 0;
  const stageEl = document.getElementById('analyzingStage');
  stageEl.textContent = stages[0];
  const iv = setInterval(() => {
    si++;
    if(si < stages.length) stageEl.textContent = stages[si];
  }, 1000);

  setTimeout(() => {
    clearInterval(iv);
    document.getElementById('analyzingWrap').classList.add('hidden');
    document.getElementById('genReportBtn').classList.remove('hidden');
    buildReport();
    document.getElementById('reportContainer').classList.remove('hidden');
    addPoints(10, '生成AI健康报告');
    checkDailyChallenge('view_report');
    document.getElementById('reportActions').classList.remove('hidden');
  }, 3000);
}

function saveReportAsImage() {
  if(!window.html2canvas) {
    alert('图片导出功能正在加载，请稍后再试');
    return;
  }
  var btn = document.getElementById('saveReportBtn');
  var origText = btn.innerHTML;
  btn.innerHTML = '&#x23F3; 正在生成图片...';
  btn.disabled = true;
  var container = document.getElementById('reportContainer');
  html2canvas(container, {
    backgroundColor: '#FFFFFF',
    scale: 2,
    useCORS: true,
    logging: false,
    windowWidth: container.scrollWidth,
    windowHeight: container.scrollHeight
  }).then(function(canvas) {
    canvas.toBlob(function(blob) {
      var now = new Date();
      var dateStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = '健康报告_' + dateStr + '.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      btn.innerHTML = origText;
      btn.disabled = false;
      addPoints(5, '保存健康报告');
    }, 'image/png');
  }).catch(function(err) {
    console.error('html2canvas error:', err);
    btn.innerHTML = origText;
    btn.disabled = false;
    alert('图片生成失败，请重试');
  });
}

function buildReport() {
  const d = healthData;
  const pred = calcPrediction();
  const score = calcHealthScore();
  const bmi = d.height && d.weight ? (d.weight / ((d.height/100)**2)).toFixed(1) : null;
  const genderText = d.gender === 'female' ? '女性' : '男性';
  const sys = d.systolic || 120;
  const dia = d.diastolic || 80;
  const glu = d.glucose || 5.0;
  const hr = d.heartrate || 72;
  const ox = d.oxygen || 98;
  const sl = d.sleep || 7;
  const steps = d.steps || 0;
  const ex = d.exercise || 0;
  const smokingLabels = {never:'从不吸烟',quit:'已戒烟',occasional:'偶尔吸烟',frequent:'经常吸烟'};
  const alcoholLabels = {never:'从不饮酒',occasional:'偶尔饮酒',frequent:'经常饮酒'};
  const smokingText = smokingLabels[d.smoking] || '未知';
  const alcoholText = alcoholLabels[d.alcohol] || '未知';

  // BP category
  let bpCat = '正常';
  if(sys >= 180 || dia >= 120) bpCat = '高血压危象';
  else if(sys >= 140 || dia >= 90) bpCat = '高血压';
  else if(sys >= 130 || dia >= 85) bpCat = '偏高';
  else if(sys >= 120) bpCat = '正常偏高';

  // Glucose category
  let gluCat = '正常';
  if(glu >= 7.0) gluCat = '糖尿病范围';
  else if(glu >= 6.1) gluCat = '糖尿病前期';

  // BMI category
  let bmiCat = '';
  if(bmi) {
    if(bmi < 18.5) bmiCat = '偏瘦';
    else if(bmi <= 23.9) bmiCat = '正常';
    else if(bmi <= 27.9) bmiCat = '超重';
    else bmiCat = '肥胖';
  }

  let html = '';

  // A) Overall Assessment
  html += `<div class="report-section card"><div class="rs-title">📋 健康总评</div>`;
  html += `<div class="report-narrative">根据您提供的健康数据综合分析，您是一位${d.age}岁的${genderText}，${bmi ? `当前BMI为${bmi}（${bmiCat}）` : '体重数据未提供'}。您的整体健康评分为${score.total}分（满分100分），${score.total >= 75 ? '处于良好水平，但仍有优化空间' : score.total >= 50 ? '处于中等水平，建议关注以下几个方面进行改善' : '处于需要重点关注的水平，建议尽快采取改善措施并咨询医生'}。</div>`;
  html += `<div class="report-narrative">您的血压${sys}/${dia}mmHg（${bpCat}），${bpCat === '正常' ? '处于理想范围内' : '建议定期监测并注意饮食调整'}；空腹血糖${glu}mmol/L（${gluCat}），${gluCat === '正常' ? '维持在健康水平' : '需要注意饮食控制和定期复查'}；静息心率${hr}bpm，${hr >= 60 && hr <= 80 ? '处于正常范围' : '建议关注心脏健康'}；血氧饱和度${ox}%，${ox >= 95 ? '正常' : '偏低，建议进一步检查'}。</div>`;
  html += `<div class="report-narrative">生活习惯方面，您${smokingText}，${alcoholText}，每周运动${ex}分钟${ex >= 150 ? '，达到了WHO推荐标准' : '，未达到WHO推荐的每周150分钟中等强度运动标准'}。每日步数${steps}步，${steps >= 8000 ? '保持了良好的日常活动量' : '建议增加日常步行量'}。睡眠时长${sl}小时，${sl >= 7 && sl <= 8 ? '处于理想范围' : '建议调整至7-8小时'}。${(d.family||[]).length > 0 ? '考虑到您的家族病史（' + d.family.map(f=>({hypertension:'高血压',diabetes:'糖尿病',heart:'心脏病',cancer:'癌症'}[f]||f)).join('、') + '），需要更加重视相关指标的监测。' : ''}</div>`;
  html += `</div>`;

  // B) Metric Details
  html += `<div class="report-section card"><div class="rs-title">📊 指标详解</div>`;
  const metricDetails = [
    { name:'血压', val:`${sys}/${dia}`, unit:'mmHg', normal:'<120/80', warn:'120-139/80-89', danger:'>=140/90', current:sys, min:80, max:200, normMin:90, normMax:120, warnMax:140 },
    { name:'空腹血糖', val:glu, unit:'mmol/L', normal:'3.9-6.1', warn:'6.1-7.0', danger:'>=7.0', current:glu, min:3, max:12, normMin:3.9, normMax:6.1, warnMax:7.0 },
    { name:'心率', val:hr, unit:'bpm', normal:'60-100', warn:'50-60/100-110', danger:'<50/>110', current:hr, min:40, max:130, normMin:60, normMax:100, warnMax:110 },
    { name:'血氧', val:ox, unit:'%', normal:'95-100', warn:'90-95', danger:'<90', current:ox, min:80, max:100, normMin:95, normMax:100, warnMax:95 },
    { name:'体温', val:d.temp||36.5, unit:'°C', normal:'36.1-37.2', warn:'37.3-38.0', danger:'>38.0', current:d.temp||36.5, min:35, max:40, normMin:36.1, normMax:37.2, warnMax:38 },
    { name:'睡眠', val:sl, unit:'小时', normal:'7-9', warn:'6-7', danger:'<6/>10', current:sl, min:3, max:12, normMin:7, normMax:9, warnMax:10 }
  ];
  if(bmi) metricDetails.push({ name:'BMI', val:bmi, unit:'kg/m²', normal:'18.5-23.9', warn:'24-27.9', danger:'>=28', current:parseFloat(bmi), min:14, max:40, normMin:18.5, normMax:23.9, warnMax:28 });

  metricDetails.forEach(m => {
    const pct = ((m.current - m.min) / (m.max - m.min)) * 100;
    const inNormal = m.current >= m.normMin && m.current <= m.normMax;
    const trend = getTrend(m.name === '血压' ? 'systolic' : m.name === '空腹血糖' ? 'glucose' : m.name === '心率' ? 'heartrate' : m.name === '血氧' ? 'oxygen' : m.name === '体温' ? 'temp' : m.name === '睡眠' ? 'sleep' : 'weight');
    const trendText = trend === 'up' ? '上升趋势' : trend === 'down' ? '下降趋势' : '保持稳定';
    const statusColor = inNormal ? 'var(--green)' : m.current > m.warnMax ? 'var(--coral)' : 'var(--gold)';
    html += `<div style="margin-bottom:12px;padding:8px 0;border-bottom:1px solid var(--glass-border)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <span style="font-size:13px;font-weight:600">${m.name}</span>
        <span style="font-size:14px;font-family:var(--mono);font-weight:700;color:${getCSSColor(statusColor)}">${m.val} ${m.unit}</span>
      </div>
      <div class="range-indicator"><div class="range-bar"><div class="range-marker" style="left:${Math.max(2,Math.min(98,pct))}%"></div></div>
        <div class="range-labels"><span>${m.min}</span><span style="color:var(--green)">正常: ${m.normal}</span><span>${m.max}</span></div>
      </div>
      <div style="font-size:11px;color:var(--text2);margin-top:4px">趋势: ${trendText} | ${inNormal ? '✅ 处于正常范围内' : '⚠️ 偏离正常范围，建议关注'}</div>
    </div>`;
  });
  html += `</div>`;

  // C) Risk Factor Analysis
  html += `<div class="report-section"><div class="rs-title" style="margin-top:14px">⚠️ 风险因素分析</div>`;

  function assessRisk(name, factors, systems, desc, action) {
    let severity = 0;
    factors.forEach(f => severity += f);
    let level, cls, badge;
    if(severity >= 5) { level = '高风险'; cls = 'risk-high'; badge = '高'; }
    else if(severity >= 3) { level = '中风险'; cls = 'risk-medium'; badge = '中'; }
    else if(severity >= 1) { level = '需关注'; cls = 'risk-watch'; badge = '关注'; }
    else { level = '正常'; cls = 'risk-normal'; badge = '正常'; }
    return `<div class="card risk-card ${cls}"><div class="risk-header"><span class="risk-name">${name}</span><span class="risk-badge">${badge}</span></div><div class="risk-desc">${desc}</div><div class="risk-systems">相关系统: ${systems}</div><div class="risk-action">建议: ${action}</div></div>`;
  }

  // Cardiovascular
  let cvFactors = [];
  if(sys >= 140) cvFactors.push(3); else if(sys >= 130) cvFactors.push(1);
  if(d.smoking === 'frequent') cvFactors.push(3); else if(d.smoking === 'occasional') cvFactors.push(1);
  if(bmi && parseFloat(bmi) >= 28) cvFactors.push(2); else if(bmi && parseFloat(bmi) >= 24) cvFactors.push(1);
  if(ex < 60) cvFactors.push(1);
  if(hr > 100) cvFactors.push(1);
  if((d.family||[]).includes('heart') || (d.family||[]).includes('hypertension')) cvFactors.push(2);
  if(glu >= 6.1) cvFactors.push(1);
  const cvTotal = cvFactors.reduce((a,b)=>a+b,0);
  html += assessRisk('心血管风险', cvFactors, '心脏、血管、脑血管',
    `您的血压为${sys}/${dia}mmHg（${bpCat}），心率${hr}bpm，${d.smoking === 'frequent' ? '加上经常吸烟的习惯，' : ''}${glu >= 6.1 ? '血糖偏高进一步增加了风险，' : ''}${cvTotal >= 5 ? '综合评估显示心血管风险较高，多个风险因素叠加可能显著增加心脑血管事件的发生概率。' : cvTotal >= 3 ? '存在一定的心血管风险因素，建议积极干预可控因素。' : cvTotal >= 1 ? '心血管风险总体可控，但仍需保持健康生活方式。' : '心血管指标良好，请继续保持。'}`,
    cvTotal >= 3 ? '建议进行心电图和血脂全套检查，控制血压和血糖，增加有氧运动。' : '保持当前良好习惯，定期体检。');

  // Metabolic syndrome
  let metaFactors = [];
  if(glu >= 7.0) metaFactors.push(3); else if(glu >= 6.1) metaFactors.push(2);
  if(bmi && parseFloat(bmi) >= 28) metaFactors.push(2); else if(bmi && parseFloat(bmi) >= 24) metaFactors.push(1);
  if(sys >= 140) metaFactors.push(1);
  if((d.family||[]).includes('diabetes')) metaFactors.push(2);
  html += assessRisk('代谢综合征风险', metaFactors, '内分泌系统、胰腺、肝脏',
    `血糖${glu}mmol/L（${gluCat}），${bmi ? `BMI ${bmi}（${bmiCat}）` : ''}。${glu >= 6.1 && bmi && parseFloat(bmi) >= 24 ? '血糖偏高伴随超重是代谢综合征的典型特征，两者相互加重，需要同时干预。' : glu >= 6.1 ? '血糖偏高需要注意饮食结构和定期监测。' : '代谢指标基本正常。'}${(d.family||[]).includes('diabetes') ? '家族糖尿病史增加了您的患病风险。' : ''}`,
    glu >= 6.1 ? '建议进行糖化血红蛋白检查，控制碳水化合物摄入，增加运动量。' : '保持均衡饮食和适量运动。');

  // Respiratory
  let respFactors = [];
  if(ox < 90) respFactors.push(3); else if(ox < 95) respFactors.push(1);
  if(d.smoking === 'frequent') respFactors.push(3); else if(d.smoking === 'occasional') respFactors.push(1);
  html += assessRisk('呼吸系统风险', respFactors, '肺、支气管、呼吸道',
    `血氧饱和度${ox}%，${ox >= 95 ? '处于正常范围' : '低于正常值95%'}。${d.smoking === 'frequent' ? '经常吸烟严重损害肺功能，是慢性阻塞性肺病和肺癌的主要风险因素。' : d.smoking === 'occasional' ? '偶尔吸烟也会对肺功能造成累积损害。' : '不吸烟有助于维护呼吸系统健康。'}`,
    d.smoking === 'frequent' || d.smoking === 'occasional' ? '强烈建议戒烟，进行肺功能检查。' : '保持良好的空气质量意识，避免二手烟。');

  // Musculoskeletal
  let msFactors = [];
  if(bmi && parseFloat(bmi) >= 28) msFactors.push(2);
  if(ex < 60) msFactors.push(2); else if(ex < 150) msFactors.push(1);
  if(d.age > 50) msFactors.push(1);
  html += assessRisk('骨骼肌肉风险', msFactors, '骨骼、关节、肌肉',
    `${bmi && parseFloat(bmi) >= 28 ? '体重过重增加了关节负担，' : ''}每周运动${ex}分钟，${ex < 60 ? '运动不足会导致肌肉流失和骨密度下降。' : ex < 150 ? '建议适当增加运动量以维护骨骼健康。' : '运动量充足，有助于维持骨骼和肌肉健康。'}${d.age > 50 ? '随着年龄增长，骨质疏松风险增加，建议关注钙和维生素D的摄入。' : ''}`,
    ex < 150 ? '增加力量训练和负重运动，补充钙质和维生素D。' : '继续保持规律运动，注意运动中的关节保护。');

  // Mental health
  let mhFactors = [];
  if(sl < 6 || sl > 9) mhFactors.push(2); else if(sl < 7) mhFactors.push(1);
  if(ex < 60) mhFactors.push(2); else if(ex < 150) mhFactors.push(1);
  html += assessRisk('心理健康风险', mhFactors, '神经系统、内分泌系统',
    `睡眠${sl}小时，${sl >= 7 && sl <= 8 ? '处于理想范围' : sl < 6 ? '严重不足，可能影响情绪调节和认知功能' : sl > 9 ? '过长可能与情绪低落相关' : '略有不足'}。每周运动${ex}分钟，${ex >= 150 ? '规律运动有助于释放压力和改善情绪。' : '运动不足可能影响大脑神经递质的正常分泌，建议增加运动。'}`,
    sl < 7 || ex < 150 ? '改善睡眠习惯，增加户外运动，必要时进行心理健康筛查。' : '保持规律作息和运动习惯。');

  // Liver
  let liverFactors = [];
  if(d.alcohol === 'frequent') liverFactors.push(3); else if(d.alcohol === 'occasional') liverFactors.push(0.5);
  if(bmi && parseFloat(bmi) >= 28) liverFactors.push(2);
  html += assessRisk('肝脏风险', liverFactors, '肝脏、胆囊',
    `${alcoholText}，${d.alcohol === 'frequent' ? '长期大量饮酒是酒精性肝病的主要原因，可导致脂肪肝、肝硬化甚至肝癌。' : d.alcohol === 'occasional' ? '适量饮酒对肝脏影响较小，但仍需注意。' : '不饮酒有利于肝脏健康。'}${bmi && parseFloat(bmi) >= 28 ? '超重/肥胖增加了非酒精性脂肪肝的风险。' : ''}`,
    d.alcohol === 'frequent' ? '强烈建议减少饮酒量，进行肝功能检查和腹部超声。' : '保持健康体重，适量饮酒。');

  // Cancer
  let cancerFactors = [];
  if(d.smoking === 'frequent') cancerFactors.push(3); else if(d.smoking === 'occasional') cancerFactors.push(1);
  if(d.alcohol === 'frequent') cancerFactors.push(1);
  if(bmi && parseFloat(bmi) >= 28) cancerFactors.push(1);
  if((d.family||[]).includes('cancer')) cancerFactors.push(3);
  html += assessRisk('癌症风险', cancerFactors, '全身多系统',
    `${d.smoking !== 'never' ? '吸烟显著增加肺癌及多种癌症风险。' : ''}${d.alcohol === 'frequent' ? '经常饮酒增加肝癌、食管癌等风险。' : ''}${bmi && parseFloat(bmi) >= 28 ? '肥胖与结直肠癌、乳腺癌等多种癌症相关。' : ''}${(d.family||[]).includes('cancer') ? '家族癌症史是重要的风险因素，建议加强筛查。' : ''}${d.smoking === 'never' && d.alcohol !== 'frequent' && (!bmi || parseFloat(bmi) < 28) && !(d.family||[]).includes('cancer') ? '当前未发现明显的癌症高风险因素，保持健康生活方式是最好的预防。' : ''}`,
    (d.family||[]).includes('cancer') || d.smoking === 'frequent' ? '定期进行防癌筛查，针对性检查高风险部位。' : '保持健康生活方式，按时进行常规体检。');

  // Immune
  let immuneFactors = [];
  if(sl < 6) immuneFactors.push(2); else if(sl < 7 || sl > 9) immuneFactors.push(1);
  if(ex < 60) immuneFactors.push(1);
  if(d.age > 60) immuneFactors.push(1);
  html += assessRisk('免疫系统风险', immuneFactors, '免疫系统、淋巴系统',
    `睡眠${sl}小时${sl < 7 ? '，睡眠不足会显著削弱免疫功能' : '，睡眠充足有助于免疫系统修复'}。运动量${ex >= 150 ? '充足，规律运动能增强免疫力' : '不足，缺乏运动可能降低免疫功能'}。${d.age > 60 ? '年龄增长导致免疫功能自然衰退。' : ''}`,
    sl < 7 || ex < 150 ? '改善睡眠质量，增加适量运动，保证营养均衡。' : '继续保持良好的生活习惯以维护免疫力。');

  html += `</div>`;
  document.getElementById('reportContainer').innerHTML = html;

  // Continue building remaining sections
  buildReportPart2(d, pred, score, bmi, bmiCat, sys, dia, glu, hr, ox, sl, steps, ex, genderText, smokingText, alcoholText, bpCat, gluCat);
}
function buildReportPart2(d, pred, score, bmi, bmiCat, sys, dia, glu, hr, ox, sl, steps, ex, genderText, smokingText, alcoholText, bpCat, gluCat) {
  const container = document.getElementById('reportContainer');
  let html = container.innerHTML;

  // D) Personalized Improvement Plan
  html += `<div class="report-section"><div class="rs-title" style="margin-top:14px">💡 个性化改善方案</div>`;

  const recs = [];

  // Exercise prescription
  if(ex < 150) {
    recs.push({
      icon: '🏃', title: '运动处方', priority: 'urgent', priorityText: '紧急',
      desc: `您目前每周运动${ex}分钟，远低于WHO推荐的150分钟。缺乏运动是多种慢性病的重要风险因素，直接影响心血管健康、代谢功能和心理状态。建议从低强度运动开始，如快走、游泳，逐步增加运动时间和强度。`,
      target: `将每周运动时间从当前的${ex}分钟提升至150分钟以上`,
      timeline: '建议在4-6周内逐步达成',
      benefit: '可降低心血管疾病风险30%，改善血糖控制，提升睡眠质量'
    });
  } else if(ex < 300) {
    recs.push({
      icon: '🏃', title: '运动优化', priority: 'recommended', priorityText: '建议',
      desc: `您每周运动${ex}分钟，已达基本标准。建议增加力量训练和高强度间歇训练（HIIT），进一步提升心肺功能和肌肉力量。`,
      target: `将每周运动时间提升至300分钟，其中包含2次力量训练`,
      timeline: '建议在2-4周内逐步调整',
      benefit: '可进一步改善心肺功能和体成分'
    });
  }

  // Diet
  if(bmi && (parseFloat(bmi) >= 24 || glu >= 6.1)) {
    recs.push({
      icon: '🥗', title: '饮食调整', priority: parseFloat(bmi) >= 28 || glu >= 7.0 ? 'urgent' : 'important', priorityText: parseFloat(bmi) >= 28 || glu >= 7.0 ? '紧急' : '重要',
      desc: `${parseFloat(bmi) >= 24 ? `您的BMI为${bmi}（${bmiCat}），需要通过饮食控制来管理体重。` : ''}${glu >= 6.1 ? `血糖${glu}mmol/L偏高，建议减少精制碳水化合物和含糖食品的摄入。` : ''}推荐采用地中海饮食模式，增加蔬菜、全谷物和优质蛋白的比例，减少加工食品。`,
      target: `${parseFloat(bmi) >= 24 ? `将体重从${d.weight}kg减至${Math.round(23.5*(d.height/100)**2)}kg（BMI 23.5）` : ''}${glu >= 6.1 ? '，将空腹血糖控制在6.0mmol/L以下' : ''}`,
      timeline: '建议在3-6个月内逐步实现',
      benefit: '每减重5%可显著改善代谢指标，降低心血管风险'
    });
  }

  // Sleep
  if(sl < 7 || sl > 9) {
    recs.push({
      icon: '😴', title: '睡眠优化', priority: sl < 6 ? 'urgent' : 'important', priorityText: sl < 6 ? '紧急' : '重要',
      desc: `您目前睡眠${sl}小时，${sl < 7 ? '不足' : '过长'}。${sl < 7 ? '睡眠不足会影响免疫力、认知功能和情绪调节，增加肥胖和心血管疾病风险。' : '睡眠过长可能与某些健康问题相关，也可能降低白天的活力。'}建议建立规律的睡眠作息，创造良好的睡眠环境。`,
      target: `将每日睡眠时间调整至7-8小时`,
      timeline: '建议在1-2周内建立新的作息规律',
      benefit: '改善免疫功能、认知表现和情绪稳定性'
    });
  }

  // Smoking
  if(d.smoking === 'frequent' || d.smoking === 'occasional') {
    recs.push({
      icon: '🚭', title: '戒烟建议', priority: 'urgent', priorityText: '紧急',
      desc: `吸烟是最大的可预防死亡原因之一。${d.smoking === 'frequent' ? '经常吸烟' : '偶尔吸烟'}会显著增加肺癌、心血管疾病、慢性阻塞性肺病等多种疾病的风险。戒烟后20分钟内心率和血压开始恢复正常，1年后心脏病风险降低一半。`,
      target: `完全戒烟`,
      timeline: '建议立即开始，可寻求戒烟门诊帮助',
      benefit: `戒烟可使预期寿命增加${d.smoking === 'frequent' ? '5-7' : '2-3'}年`
    });
  }

  // Alcohol
  if(d.alcohol === 'frequent') {
    recs.push({
      icon: '🍷', title: '饮酒控制', priority: 'important', priorityText: '重要',
      desc: `经常饮酒对肝脏、心血管和神经系统都有负面影响。建议严格限制饮酒量，男性每日不超过25g酒精（约1瓶啤酒或1两白酒），女性减半。最好的选择是不饮酒。`,
      target: `将饮酒频率降至偶尔或完全戒酒`,
      timeline: '建议在2-4周内逐步减少饮酒量',
      benefit: '降低肝脏疾病和心血管风险，改善睡眠质量'
    });
  }

  // BP management
  if(sys >= 130) {
    recs.push({
      icon: '🩺', title: '血压管理', priority: sys >= 140 ? 'urgent' : 'important', priorityText: sys >= 140 ? '紧急' : '重要',
      desc: `您的血压${sys}/${dia}mmHg（${bpCat}），${sys >= 140 ? '已达到高血压标准，需要积极干预。' : '处于偏高水平，应注意预防。'}建议低盐饮食（每日<5g），增加钾的摄入（香蕉、深色蔬菜），进行规律有氧运动，管理压力。${sys >= 140 ? '建议在生活方式干预的同时咨询医生是否需要药物治疗。' : ''}`,
      target: `将血压控制在120/80mmHg以下`,
      timeline: sys >= 140 ? '建议立即就医，同时开始生活方式调整' : '建议在4-8周内观察改善效果',
      benefit: '血压每降低10mmHg，心血管事件风险降低20%'
    });
  }

  // Steps
  if(steps < 8000) {
    recs.push({
      icon: '👟', title: '增加日常活动', priority: 'recommended', priorityText: '建议',
      desc: `您每日步数${steps}步，研究表明每日步行8000-10000步可显著降低全因死亡率。建议通过通勤步行、午休散步、爬楼梯等方式增加日常活动量。`,
      target: `将每日步数从当前的${steps}步提升至8000步`,
      timeline: '建议在2-4周内逐步达成',
      benefit: '降低全因死亡风险15-20%，改善心血管健康'
    });
  }

  if(recs.length === 0) {
    recs.push({
      icon: '✅', title: '保持当前状态', priority: 'recommended', priorityText: '建议',
      desc: '您的各项指标都在正常范围内，生活习惯良好。继续保持当前的健康生活方式，定期体检以监测各项指标的变化。',
      target: '维持当前健康水平',
      timeline: '持续执行',
      benefit: '长期维持良好健康状态'
    });
  }

  recs.forEach(r => {
    html += `<div class="card rec-card">
      <div class="rec-header"><span class="rec-icon">${r.icon}</span><span class="rec-title">${r.title}</span><span class="rec-priority ${r.priority}">${r.priorityText}</span></div>
      <div class="rec-desc">${r.desc}</div>
      <div class="rec-target">🎯 目标: ${r.target}</div>
      <div class="rec-timeline">📅 时间: ${r.timeline}</div>
      <div class="rec-benefit">✨ 预期收益: ${r.benefit}</div>
    </div>`;
  });
  html += `</div>`;

  // E) Lifespan Prediction Details
  if(pred) {
    html += `<div class="report-section card" style="margin-top:14px"><div class="rs-title">🔮 寿命预测详解</div>`;
    html += `<div style="text-align:center;padding:10px 0"><div style="font-size:13px;color:var(--text2)">预测寿命范围</div><div style="font-family:var(--mono);font-size:36px;font-weight:800;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">${pred.low} - ${pred.high} 岁</div><div style="font-size:11px;color:var(--text3);margin-top:4px">置信度: 65% | 基于当前健康数据评估</div></div>`;

    // Waterfall factors
    html += `<div style="margin-top:12px;font-size:13px;font-weight:600;margin-bottom:8px">影响因素分析</div>`;
    const baseAge = d.gender === 'female' ? 81 : 76;
    const factors = [];
    if(bmi) {
      const bmiVal = parseFloat(bmi);
      if(bmiVal >= 18.5 && bmiVal <= 23.9) factors.push({name:'体重(BMI正常)',val:+2});
      else if(bmiVal >= 28) factors.push({name:'体重(肥胖)',val:-3});
      else if(bmiVal >= 24) factors.push({name:'体重(超重)',val:-1});
      else factors.push({name:'体重(偏瘦)',val:-1});
    }
    const exMap = [{min:0,max:60,val:-3,label:'运动不足'},{min:60,max:150,val:-1,label:'运动偏少'},{min:150,max:300,val:+2,label:'运动充足'},{min:300,max:9999,val:+3,label:'运动优秀'}];
    const exF = exMap.find(e => ex >= e.min && ex < e.max);
    if(exF) factors.push({name:exF.label, val:exF.val});
    const smokingImpact = {never:0,quit:-1,occasional:-3,frequent:-7};
    if(smokingImpact[d.smoking] !== undefined && smokingImpact[d.smoking] !== 0) factors.push({name:d.smoking==='frequent'?'经常吸烟':d.smoking==='occasional'?'偶尔吸烟':'已戒烟', val:smokingImpact[d.smoking]});
    const alcoholImpact = {never:0,occasional:-0.5,frequent:-4};
    if(alcoholImpact[d.alcohol] !== undefined && alcoholImpact[d.alcohol] !== 0) factors.push({name:d.alcohol==='frequent'?'经常饮酒':'偶尔饮酒', val:alcoholImpact[d.alcohol]});
    if(sys < 120) factors.push({name:'血压正常',val:+1}); else if(sys >= 160) factors.push({name:'血压很高',val:-5}); else if(sys >= 140) factors.push({name:'血压偏高',val:-3}); else if(sys >= 130) factors.push({name:'血压略高',val:-1});
    if(glu < 6.1) factors.push({name:'血糖正常',val:+1}); else if(glu >= 7.0) factors.push({name:'血糖偏高',val:-5}); else factors.push({name:'血糖略高',val:-2});
    if(sl >= 7 && sl <= 8) factors.push({name:'睡眠充足',val:+1}); else if(sl < 6 || sl > 9) factors.push({name:'睡眠异常',val:-2});
    if(hr >= 60 && hr <= 80) factors.push({name:'心率正常',val:+1}); else if(hr < 50 || hr > 100) factors.push({name:'心率异常',val:-2});
    if((d.family||[]).length > 0) factors.push({name:'家族病史',val:-(d.family||[]).length});

    const maxAbs = Math.max(...factors.map(f=>Math.abs(f.val)),1);
    factors.forEach(f => {
      const barW = Math.abs(f.val)/maxAbs*60;
      html += `<div class="waterfall-item"><div class="wf-label">${f.name}</div><div class="wf-bar-wrap"><div class="wf-bar ${f.val>=0?'positive':'negative'}" style="width:${barW}%"></div></div><div class="wf-value ${f.val>=0?'positive':'negative'}">${f.val>0?'+':''}${f.val}年</div></div>`;
    });

    // Improved scenario
    let improved = pred.predicted;
    if(d.smoking === 'frequent') improved += 5;
    else if(d.smoking === 'occasional') improved += 2;
    if(ex < 150) improved += 3;
    if(sl < 7 || sl > 9) improved += 1.5;
    if(bmi && parseFloat(bmi) >= 24) improved += 2;
    improved = Math.round(improved);

    if(improved > pred.predicted) {
      html += `<div style="margin-top:14px;padding:12px;background:rgba(64,145,108,0.06);border:1px solid rgba(64,145,108,0.15);border-radius:10px"><div style="font-size:13px;font-weight:600;color:var(--green);margin-bottom:4px">🌟 改善后预测</div><div style="font-size:12px;color:var(--text2)">如果积极改善上述可控因素，您的预期寿命可提升至约 <strong style="color:var(--green)">${improved} 岁</strong>，比当前预测增加 <strong style="color:var(--green)">+${improved - pred.predicted} 年</strong>。</div></div>`;
    }

    // Health trajectory chart
    html += `<div style="margin-top:14px;font-size:13px;font-weight:600;margin-bottom:4px">健康轨迹预测</div><div class="chart-container"><canvas id="trajectoryChart"></canvas></div>`;
    html += `</div>`;
  }

  // F) Monitoring Recommendations
  html += `<div class="report-section" style="margin-top:14px"><div class="rs-title">📅 定期监测建议</div>`;
  const monitors = [
    { icon:'🩸', name:'血压', freq: sys >= 140 ? '每天监测' : sys >= 130 ? '每周2-3次' : '每月1次' },
    { icon:'💧', name:'血糖', freq: glu >= 7.0 ? '每天监测' : glu >= 6.1 ? '每周1次空腹血糖' : '每3个月1次' },
    { icon:'❤️', name:'心率', freq: '使用穿戴设备持续监测' },
    { icon:'⚖️', name:'体重', freq: '每周1次，固定时间' },
    { icon:'🫁', name:'血氧', freq: ox < 95 ? '每天监测' : '有不适时检查' },
    { icon:'😴', name:'睡眠', freq: '使用穿戴设备持续追踪' }
  ];
  monitors.forEach(m => {
    html += `<div class="card monitor-card"><div class="mon-icon">${m.icon}</div><div class="mon-info"><div class="mon-name">${m.name}</div><div class="mon-freq">${m.freq}</div></div></div>`;
  });

  // Doctor visit
  html += `<div class="card" style="padding:12px;margin-top:8px"><div style="font-size:13px;font-weight:600;margin-bottom:6px">🏥 就医建议</div>`;
  const docReasons = [];
  if(sys >= 140) docReasons.push('血压持续偏高（需排除高血压）');
  if(glu >= 6.1) docReasons.push('血糖偏高（需排除糖尿病）');
  if(hr > 100 || hr < 50) docReasons.push('心率异常');
  if(ox < 95) docReasons.push('血氧偏低');
  if(docReasons.length > 0) {
    html += `<div style="font-size:12px;color:var(--coral);margin-bottom:4px">⚠️ 建议尽快就医检查：</div>`;
    docReasons.forEach(r => html += `<div style="font-size:12px;color:var(--text2);padding-left:12px">• ${r}</div>`);
  } else {
    html += `<div style="font-size:12px;color:var(--green)">✅ 当前无需紧急就医，建议定期体检即可。</div>`;
  }
  html += `</div>`;

  // Screenings
  html += `<div class="card" style="padding:12px;margin-top:8px"><div style="font-size:13px;font-weight:600;margin-bottom:6px">🔬 建议体检项目</div>`;
  const screenings = [];
  if(d.age >= 18) screenings.push('血压、血糖、血脂全套（每年）');
  if(d.age >= 40) screenings.push('心电图（每年）');
  if(d.age >= 40 && d.gender === 'male') screenings.push('前列腺检查（每年）');
  if(d.age >= 40 && d.gender === 'female') screenings.push('乳腺X线检查（每1-2年）');
  if(d.age >= 45) screenings.push('肠镜检查（每5年）');
  if(d.age >= 50) screenings.push('骨密度检查（每2年）');
  if(d.smoking !== 'never' && d.age >= 50) screenings.push('低剂量CT肺癌筛查（每年）');
  if((d.family||[]).includes('cancer')) screenings.push('针对性肿瘤标志物筛查（每年）');
  screenings.push('常规体检（每年）');
  screenings.forEach(s => html += `<div style="font-size:12px;color:var(--text2);padding:2px 0 2px 12px">• ${s}</div>`);
  html += `</div></div>`;

  container.innerHTML = html;

  // Draw trajectory chart after DOM update
  if(pred) {
    requestAnimationFrame(() => drawTrajectoryChart(d, pred, score));
  }
}

function drawTrajectoryChart(d, pred, score) {
  const canvas = document.getElementById('trajectoryChart');
  if(!canvas || typeof Chart === 'undefined') return;

  const currentAge = d.age;
  const years = [];
  const currentScores = [];
  const improvedScores = [];

  for(let y=0; y<=30; y+=5) {
    const age = currentAge + y;
    years.push(age + '岁');
    // Current trajectory
    const decay = Math.max(20, score.total - y*1.2);
    currentScores.push(Math.round(decay));
    // Improved trajectory
    const improved = Math.max(30, Math.min(95, score.total + 10 - y*0.6));
    improvedScores.push(Math.round(improved));
  }

  new Chart(canvas, {
    type: 'line',
    data: {
      labels: years,
      datasets: [
        { label: '当前趋势', data: currentScores, borderColor: '#E76F51', backgroundColor: 'rgba(231,111,81,0.1)', fill: true, tension: 0.4, pointRadius: 3, borderWidth: 2 },
        { label: '改善后趋势', data: improvedScores, borderColor: '#40916C', backgroundColor: 'rgba(64,145,108,0.1)', fill: true, tension: 0.4, pointRadius: 3, borderWidth: 2, borderDash: [5,5] }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: 'rgba(58,48,40,0.6)', font: { size: 10 } } } },
      scales: {
        x: { ticks: { color: 'rgba(58,48,40,0.4)', font: { size: 9 } }, grid: { color: 'rgba(120,90,60,0.06)' } },
        y: { min: 0, max: 100, ticks: { color: 'rgba(58,48,40,0.4)', font: { size: 9 } }, grid: { color: 'rgba(120,90,60,0.06)' } }
      }
    }
  });
}
// ============================================================
// TAB 3: TIME MANAGEMENT
// ============================================================
let currentPriority = 'high';
let countdownInterval = null;

function selectPriority(p) {
  currentPriority = p;
  document.querySelectorAll('.priority-opt').forEach(b => b.classList.toggle('active', b.dataset.p === p));
}

function refreshTimeTab() {
  updateDateTime();
  renderTasks();
  if(!countdownInterval) {
    countdownInterval = setInterval(updateDateTime, 1000);
  }
}

function updateDateTime() {
  const now = new Date();
  const weekdays = ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];
  document.getElementById('dateDisplay').textContent = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${weekdays[now.getDay()]}`;

  const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
  const diff = endOfDay - now;
  const h = Math.floor(diff/3600000);
  const m = Math.floor((diff%3600000)/60000);
  const s = Math.floor((diff%60000)/1000);
  document.getElementById('countdownTime').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

  const pct = ((now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds()) / 86400 * 100).toFixed(1);
  document.getElementById('dayPct').textContent = Math.round(pct) + '%';
  drawRing('dayRingCanvas', pct/100, '#2A9D8F', 3, 44);
}

function addTask() {
  const input = document.getElementById('taskInput');
  const text = input.value.trim();
  if(!text) return;
  const tasks = loadTasks();
  tasks.push({ id: Date.now(), text, priority: currentPriority, done: false, time: null });
  saveTasks(tasks);
  input.value = '';
  renderTasks();
}

document.getElementById('taskInput')?.addEventListener('keypress', (e) => {
  if(e.key === 'Enter') addTask();
});

function toggleTask(id) {
  const tasks = loadTasks();
  const t = tasks.find(x => x.id === id);
  if(t) {
    t.done = !t.done;
    if(t.done) {
      const pts = t.priority === 'high' ? 15 : t.priority === 'med' ? 10 : 5;
      addPoints(pts, '完成任务: ' + t.text);
      checkDailyChallenge('complete_task');
      if(t.priority === 'high') checkDailyChallenge('high_priority');
    }
  }
  saveTasks(tasks);
  renderTasks();
}

function deleteTask(id) {
  let tasks = loadTasks();
  tasks = tasks.filter(x => x.id !== id);
  saveTasks(tasks);
  renderTasks();
}

function renderTasks() {
  const tasks = loadTasks();
  const total = tasks.length;
  const done = tasks.filter(t=>t.done).length;
  const rate = total > 0 ? Math.round(done/total*100) : 0;

  document.getElementById('taskStats').innerHTML = `
    <div class="stat-card"><div class="stat-num" style="color:var(--green)">${done}</div><div class="stat-label">已完成</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--cyan)">${total}</div><div class="stat-label">总任务</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--gold)">${rate}%</div><div class="stat-label">完成率</div></div>
  `;

  const groups = { high:[], med:[], low:[] };
  tasks.filter(t=>!t.done).forEach(t => groups[t.priority]?.push(t));
  const doneTasks = tasks.filter(t=>t.done);

  let html = '';
  const groupInfo = [
    {key:'high', title:'🔴 高优先级', cls:'tg-high'},
    {key:'med', title:'🟡 中优先级', cls:'tg-med'},
    {key:'low', title:'🟢 低优先级', cls:'tg-low'}
  ];

  groupInfo.forEach(g => {
    if(groups[g.key].length === 0) return;
    html += `<div class="task-group"><div class="task-group-title ${g.cls}">${g.title} (${groups[g.key].length})</div>`;
    groups[g.key].forEach(t => {
      const pCls = t.priority === 'high' ? 'tp-high' : t.priority === 'med' ? 'tp-med' : 'tp-low';
      const pText = t.priority === 'high' ? '高' : t.priority === 'med' ? '中' : '低';
      html += `<div class="task-item"><div class="task-check" onclick="toggleTask(${t.id})"></div><div class="task-text">${escHtml(t.text)}</div><span class="task-priority ${pCls}">${pText}</span><button class="task-del" onclick="deleteTask(${t.id})">✕</button></div>`;
    });
    html += `</div>`;
  });

  if(doneTasks.length > 0) {
    html += `<div class="task-group completed-section"><div class="task-group-title" style="background:rgba(120,90,60,0.04);color:var(--text3)">✅ 已完成 (${doneTasks.length})</div>`;
    doneTasks.forEach(t => {
      html += `<div class="task-item"><div class="task-check checked" onclick="toggleTask(${t.id})"></div><div class="task-text done">${escHtml(t.text)}</div><button class="task-del" onclick="deleteTask(${t.id})">✕</button></div>`;
    });
    html += `</div>`;
  }

  if(tasks.length === 0) {
    html = `<div style="text-align:center;padding:30px 0;color:var(--text3)"><div style="font-size:36px;margin-bottom:8px">📝</div><div style="font-size:13px">暂无任务，添加一个开始吧</div></div>`;
  }

  document.getElementById('taskList').innerHTML = html;
}

// ============================================================
// TAB 4: LIFE PLANNING
// ============================================================
const categories = ['全部','旅行','学习','事业','家庭','健康','冒险','创造','社交'];
const catEmojis = {'旅行':'🌍','学习':'📚','事业':'💼','家庭':'🏠','健康':'💪','冒险':'🏔','创造':'🎨','社交':'🤝'};
const presets = [
  {title:'攀登雪山',cat:'冒险',desc:'挑战一座海拔5000米以上的雪山'},
  {title:'环游世界',cat:'旅行',desc:'走遍七大洲，体验不同文化'},
  {title:'学习一门乐器',cat:'学习',desc:'熟练掌握一种乐器的演奏'},
  {title:'写一本书',cat:'创造',desc:'完成一本属于自己的著作'},
  {title:'跑完马拉松',cat:'健康',desc:'完成一场全程42.195公里的马拉松'},
  {title:'学会新语言',cat:'学习',desc:'流利掌握一门新的外语'},
  {title:'创办公司',cat:'事业',desc:'创立自己的企业，实现创业梦想'},
  {title:'深海潜水',cat:'冒险',desc:'体验深海潜水，探索海底世界'},
  {title:'看极光',cat:'旅行',desc:'亲眼见证北极光的壮丽景象'},
  {title:'参加志愿服务',cat:'社交',desc:'参与公益活动，回馈社会'},
  {title:'学会烹饪',cat:'学习',desc:'掌握至少10道拿手菜'},
  {title:'拍一部短片',cat:'创造',desc:'自编自导完成一部短片作品'}
];
let currentCat = '全部';

function renderCatFilter() {
  document.getElementById('catFilter').innerHTML = categories.map(c =>
    `<button class="cat-chip ${c===currentCat?'active':''}" onclick="filterCat('${c}')">${c === '全部' ? c : (catEmojis[c]||'') + ' ' + c}</button>`
  ).join('');
}

function filterCat(c) {
  currentCat = c;
  renderCatFilter();
  renderGoals();
}

function renderGoals() {
  const pred = calcPrediction();
  const currentAge = healthData.age || 25;
  const predictedAge = pred ? pred.predicted : 80;
  const remaining = pred ? pred.remaining : 55;

  document.getElementById('remainYears').textContent = remaining;

  const filtered = currentCat === '全部' ? goals : goals.filter(g => g.cat === currentCat);
  const completed = goals.filter(g => g.status === 'done').length;

  // Goal ring
  const pct = goals.length > 0 ? completed / goals.length : 0;
  drawRing('goalRingCanvas', pct, '#40916C', 4, 60);
  document.getElementById('goalRingText').textContent = `${completed}/${goals.length}`;
  document.getElementById('goalProgressText').textContent = goals.length > 0 ? `${completed}/${goals.length} 个目标已完成` : '尚未设定人生目标';

  // Timeline
  const timelineEl = document.getElementById('lifeTimeline');
  const fillPct = ((currentAge - (currentAge > 0 ? currentAge : 20)) / (predictedAge - (currentAge > 0 ? currentAge : 20))) * 100;
  document.getElementById('timelineFill').style.width = '0%'; // At start of remaining life

  // Remove old markers
  timelineEl.querySelectorAll('.timeline-marker').forEach(m => m.remove());
  goals.forEach(g => {
    if(g.targetAge) {
      const pos = ((g.targetAge - currentAge) / (predictedAge - currentAge)) * 100;
      if(pos >= 0 && pos <= 100) {
        const statusColor = g.status === 'done' ? 'var(--green)' : g.status === 'progress' ? 'var(--cyan)' : 'var(--text3)';
        const marker = document.createElement('div');
        marker.className = 'timeline-marker';
        marker.style.left = pos + '%';
        marker.style.background = getCSSColor(statusColor);
        marker.innerHTML = `<div class="tm-label">${escHtml(g.title)}</div>`;
        timelineEl.appendChild(marker);
      }
    }
  });

  // Goal list
  let html = '';
  if(filtered.length === 0) {
    html = `<div style="text-align:center;padding:24px 0;color:var(--text3)"><div style="font-size:32px;margin-bottom:8px">🎯</div><div style="font-size:13px">${currentCat === '全部' ? '还没有人生目标，快来添加吧' : '该类别下暂无目标'}</div></div>`;
  } else {
    filtered.forEach(g => {
      const emoji = catEmojis[g.cat] || '🎯';
      const statusCls = g.status === 'done' ? 'status-done' : g.status === 'progress' ? 'status-progress' : 'status-pending';
      const statusText = g.status === 'done' ? '已完成' : g.status === 'progress' ? '进行中' : '未开始';
      html += `<div class="card goal-card">
        <button class="goal-del" onclick="deleteGoal(${g.id})">✕</button>
        <div class="goal-header"><span class="goal-emoji">${emoji}</span><span class="goal-title">${escHtml(g.title)}</span><span class="goal-cat">${escHtml(g.cat)}</span></div>
        ${g.desc ? `<div class="goal-desc">${escHtml(g.desc)}</div>` : ''}
        <div class="goal-footer"><span class="goal-age">🎂 目标年龄: ${g.targetAge || '--'} 岁</span><button class="goal-status ${statusCls}" onclick="cycleGoalStatus(${g.id})">${statusText}</button></div>
      </div>`;
    });
  }
  document.getElementById('goalList').innerHTML = html;
}

function renderPresets() {
  document.getElementById('presetChips').innerHTML = presets.map(p =>
    `<button class="preset-chip" onclick="addPreset('${p.title}','${p.cat}','${p.desc}')">${catEmojis[p.cat]||''} ${p.title}</button>`
  ).join('');
}

function addPreset(title, cat, desc) {
  const currentAge = healthData.age || 25;
  goals.push({ id: Date.now(), title, cat, desc, targetAge: currentAge + Math.floor(Math.random()*20+5), status: 'pending' });
  saveData(LS_GOALS, goals);
  renderGoals();
}

function openGoalModal() { document.getElementById('goalModal').classList.add('show'); }
function closeGoalModal() { document.getElementById('goalModal').classList.remove('show'); }

function saveGoal() {
  const title = document.getElementById('g-title').value.trim();
  if(!title) { alert('请输入目标名称'); return; }
  const cat = document.getElementById('g-cat').value;
  const age = parseInt(document.getElementById('g-age').value) || (healthData.age || 25) + 10;
  const desc = document.getElementById('g-desc').value.trim();
  goals.push({ id: Date.now(), title, cat, desc, targetAge: age, status: 'pending' });
  saveData(LS_GOALS, goals);
  addPoints(10, '添加人生目标: ' + title);
  checkDailyChallenge('add_goal');
  closeGoalModal();
  document.getElementById('g-title').value = '';
  document.getElementById('g-age').value = '';
  document.getElementById('g-desc').value = '';
  renderGoals();
}

function cycleGoalStatus(id) {
  const g = goals.find(x => x.id === id);
  if(!g) return;
  const cycle = ['pending','progress','done'];
  const cidx = cycle.indexOf(g.status);
  g.status = cycle[(cidx+1)%cycle.length];
  if(g.status === 'done') addPoints(50, '完成人生目标: ' + g.title);
  saveData(LS_GOALS, goals);
  renderGoals();
}

function deleteGoal(id) {
  goals = goals.filter(x => x.id !== id);
  saveData(LS_GOALS, goals);
  renderGoals();
}

function refreshLifeTab() {
  renderCatFilter();
  renderGoals();
  renderPresets();
}


// ============================================================
// TAB 5: ACHIEVEMENT SYSTEM
// ============================================================
const LS_POINTS = 'ln_points';
const LS_MEDALS = 'ln_medals';
const LS_STREAK = 'ln_streak';
const LS_DAILY_CHALLENGE = 'ln_daily_challenge';
const LS_POINTS_LOG = 'ln_points_log';
const LS_TAB_VISITS = 'ln_tab_visits';

const LEVELS = [
  {lv:1, name:'初行者', icon:'🌱', points:0},
  {lv:2, name:'探索者', icon:'🌿', points:100},
  {lv:3, name:'践行者', icon:'🌳', points:300},
  {lv:4, name:'奋进者', icon:'⭐', points:600},
  {lv:5, name:'守护者', icon:'🌟', points:1000},
  {lv:6, name:'引领者', icon:'💫', points:2000},
  {lv:7, name:'卓越者', icon:'🔥', points:3500},
  {lv:8, name:'大师', icon:'👑', points:5000},
  {lv:9, name:'传奇', icon:'💎', points:8000},
  {lv:10, name:'生命导航家', icon:'🏆', points:12000}
];

const MEDAL_DEFS = [
  // Health series (bronze, silver, gold, diamond)
  {id:'health_b', series:'health', tier:'bronze', icon:'💚', name:'健康新手', desc:'录入1次健康数据', check:s=>s.healthEntries>=1},
  {id:'health_s', series:'health', tier:'silver', icon:'💚', name:'健康达人', desc:'录入10次健康数据', check:s=>s.healthEntries>=10},
  {id:'health_g', series:'health', tier:'gold', icon:'💚', name:'健康专家', desc:'录入50次健康数据', check:s=>s.healthEntries>=50},
  {id:'health_d', series:'health', tier:'diamond', icon:'💚', name:'健康大师', desc:'录入100次健康数据', check:s=>s.healthEntries>=100},
  // Time series
  {id:'time_b', series:'time', tier:'bronze', icon:'⏰', name:'任务新手', desc:'完成5个任务', check:s=>s.tasksCompleted>=5},
  {id:'time_s', series:'time', tier:'silver', icon:'⏰', name:'效率达人', desc:'完成30个任务', check:s=>s.tasksCompleted>=30},
  {id:'time_g', series:'time', tier:'gold', icon:'⏰', name:'时间大师', desc:'完成100个任务', check:s=>s.tasksCompleted>=100},
  {id:'time_d', series:'time', tier:'diamond', icon:'⏰', name:'效率之神', desc:'完成500个任务', check:s=>s.tasksCompleted>=500},
  // Planning series
  {id:'plan_b', series:'planning', tier:'bronze', icon:'🎯', name:'目标新手', desc:'添加1个人生目标', check:s=>s.totalGoals>=1},
  {id:'plan_s', series:'planning', tier:'silver', icon:'🎯', name:'规划达人', desc:'添加5个人生目标', check:s=>s.totalGoals>=5},
  {id:'plan_g', series:'planning', tier:'gold', icon:'🎯', name:'梦想家', desc:'完成3个人生目标', check:s=>s.completedGoals>=3},
  {id:'plan_d', series:'planning', tier:'diamond', icon:'🎯', name:'人生赢家', desc:'完成10个人生目标', check:s=>s.completedGoals>=10},
  // Streak series
  {id:'streak_b', series:'streak', tier:'bronze', icon:'🔥', name:'初露锋芒', desc:'连续活跃3天', check:s=>s.streak>=3},
  {id:'streak_s', series:'streak', tier:'silver', icon:'🔥', name:'持之以恒', desc:'连续活跃7天', check:s=>s.streak>=7},
  {id:'streak_g', series:'streak', tier:'gold', icon:'🔥', name:'坚韧不拔', desc:'连续活跃30天', check:s=>s.streak>=30},
  {id:'streak_d', series:'streak', tier:'diamond', icon:'🔥', name:'永不止步', desc:'连续活跃100天', check:s=>s.streak>=100},
  // Score series
  {id:'score_b', series:'score', tier:'bronze', icon:'📊', name:'积分新秀', desc:'累计获得100积分', check:s=>s.totalPoints>=100},
  {id:'score_s', series:'score', tier:'silver', icon:'📊', name:'积分能手', desc:'累计获得500积分', check:s=>s.totalPoints>=500},
  {id:'score_g', series:'score', tier:'gold', icon:'📊', name:'积分王者', desc:'累计获得2000积分', check:s=>s.totalPoints>=2000},
  {id:'score_d', series:'score', tier:'diamond', icon:'📊', name:'积分传奇', desc:'累计获得10000积分', check:s=>s.totalPoints>=10000},
  // Allround series
  {id:'all_b', series:'allround', tier:'bronze', icon:'🌈', name:'全面发展', desc:'解锁3枚勋章', check:s=>s.medalsEarned>=3},
  {id:'all_s', series:'allround', tier:'silver', icon:'🌈', name:'多才多艺', desc:'解锁8枚勋章', check:s=>s.medalsEarned>=8},
  {id:'all_g', series:'allround', tier:'gold', icon:'🌈', name:'全能选手', desc:'解锁15枚勋章', check:s=>s.medalsEarned>=15},
  {id:'all_d', series:'allround', tier:'diamond', icon:'🌈', name:'完美主义', desc:'解锁全部勋章', check:s=>s.medalsEarned>=30},
  // Special medals
  {id:'sp_first', series:'special', tier:'special', icon:'⭐', name:'第一步', desc:'首次获得积分', check:s=>s.totalPoints>=1},
  {id:'sp_health80', series:'special', tier:'special', icon:'💪', name:'健康标兵', desc:'健康评分达到80分', check:s=>s.healthScore>=80},
  {id:'sp_steps10k', series:'special', tier:'special', icon:'👟', name:'万步达人', desc:'单日步数达到10000步', check:s=>s.maxSteps>=10000},
  {id:'sp_lv5', series:'special', tier:'special', icon:'🌟', name:'晋级之星', desc:'达到等级5', check:s=>s.level>=5},
  {id:'sp_challenge7', series:'special', tier:'special', icon:'🏅', name:'挑战达人', desc:'完成7次每日挑战', check:s=>s.challengesCompleted>=7},
  {id:'sp_explorer', series:'special', tier:'special', icon:'🧭', name:'全面探索', desc:'访问过所有4个模块', check:s=>s.allTabsVisited}
];

const CHALLENGE_POOL = [
  {type:'complete_task', desc:'完成至少1个任务', icon:'✅', points:15},
  {type:'complete_3_tasks', desc:'完成至少3个任务', icon:'📋', points:30},
  {type:'record_health', desc:'录入或同步健康数据', icon:'❤️', points:20},
  {type:'view_report', desc:'生成AI健康报告', icon:'📊', points:15},
  {type:'add_goal', desc:'添加一个人生目标', icon:'🎯', points:15},
  {type:'all_modules', desc:'访问全部4个模块', icon:'🧭', points:25},
  {type:'high_priority', desc:'完成一个高优先级任务', icon:'🔴', points:20},
  {type:'steps_8000', desc:'步数达到8000步', icon:'👟', points:20}
];

// Track tab visits for today
let _tabVisitsToday = loadData(LS_TAB_VISITS, {});

function trackTabVisit(idx) {
  const today = todayKey();
  if(!_tabVisitsToday.date || _tabVisitsToday.date !== today) {
    _tabVisitsToday = {date: today, tabs: []};
  }
  if(!_tabVisitsToday.tabs.includes(idx) && idx < 4) {
    _tabVisitsToday.tabs.push(idx);
    saveData(LS_TAB_VISITS, _tabVisitsToday);
    if(_tabVisitsToday.tabs.length >= 4) {
      checkDailyChallenge('all_modules');
    }
  }
}

function loadPointsData() {
  return loadData(LS_POINTS, {total: 0, level: 1});
}

function savePointsData(data) {
  saveData(LS_POINTS, data);
}

function loadPointsLog() {
  return loadData(LS_POINTS_LOG, []);
}

function savePointsLog(log) {
  saveData(LS_POINTS_LOG, log);
}

function loadMedals() {
  return loadData(LS_MEDALS, []);
}

function saveMedals(medals) {
  saveData(LS_MEDALS, medals);
}

function loadStreakData() {
  return loadData(LS_STREAK, {count: 0, lastDate: null, history: {}});
}

function saveStreakData(data) {
  saveData(LS_STREAK, data);
}

function getLevel(total) {
  let current = LEVELS[0];
  for(const lv of LEVELS) {
    if(total >= lv.points) current = lv;
    else break;
  }
  return current;
}

function addPoints(amount, reason) {
  const pd = loadPointsData();
  const oldLevel = getLevel(pd.total);
  pd.total += amount;
  const newLevel = getLevel(pd.total);
  pd.level = newLevel.lv;
  savePointsData(pd);

  // Log it
  const log = loadPointsLog();
  log.unshift({amount, reason, time: Date.now()});
  if(log.length > 50) log.length = 50;
  savePointsLog(log);

  // Check level up
  if(newLevel.lv > oldLevel.lv) {
    showToast('恭喜升级! ' + newLevel.icon + ' ' + newLevel.name + ' (Lv.' + newLevel.lv + ')');
  }

  // Check medals after every point addition
  checkMedals();
}

function getStats() {
  const pd = loadPointsData();
  const streakData = loadStreakData();
  const earnedMedals = loadMedals();
  const score = calcHealthScore();

  // Count tasks completed across all days
  let tasksCompleted = 0;
  for(let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if(key && key.startsWith('ln_tasks_')) {
      try {
        const tasks = JSON.parse(localStorage.getItem(key));
        if(Array.isArray(tasks)) {
          tasksCompleted += tasks.filter(t => t.done).length;
        }
      } catch(e) {}
    }
  }

  // Count health entries from history
  let healthEntries = 0;
  const hh = loadData(LS_HEALTH_HISTORY, {});
  const allDates = new Set();
  for(const key of Object.keys(hh)) {
    if(Array.isArray(hh[key])) {
      hh[key].forEach(entry => {
        if(entry.date) allDates.add(entry.date);
      });
    }
  }
  healthEntries = allDates.size;

  // Goals
  const totalGoals = goals.length;
  const completedGoals = goals.filter(g => g.status === 'done').length;

  // Max steps
  const stepsHist = hh.steps || [];
  let maxSteps = healthData.steps || 0;
  stepsHist.forEach(s => { if(s.value > maxSteps) maxSteps = s.value; });

  // Challenges completed count
  let challengesCompleted = 0;
  for(let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if(key && key.startsWith('ln_daily_challenge')) {
      try {
        const dc = JSON.parse(localStorage.getItem(key));
        if(dc && dc.challenges) {
          challengesCompleted += dc.challenges.filter(c => c.completed).length;
        }
      } catch(e) {}
    }
  }

  // All tabs visited
  const tv = loadData(LS_TAB_VISITS, {});
  const allTabsVisited = tv.tabs && tv.tabs.length >= 4;

  return {
    totalPoints: pd.total,
    level: pd.level,
    tasksCompleted,
    healthEntries,
    totalGoals,
    completedGoals,
    streak: streakData.count,
    maxStreak: streakData.count,
    medalsEarned: earnedMedals.length,
    healthScore: score.total,
    maxSteps,
    challengesCompleted,
    allTabsVisited
  };
}

function checkMedals() {
  const stats = getStats();
  const earned = loadMedals();
  let newMedals = false;
  MEDAL_DEFS.forEach(m => {
    if(!earned.includes(m.id)) {
      try {
        if(m.check(stats)) {
          earned.push(m.id);
          newMedals = true;
          const tierNames = {bronze:'铜', silver:'银', gold:'金', diamond:'钻石', special:'特殊'};
          showToast('解锁勋章! ' + m.icon + ' ' + m.name + ' (' + (tierNames[m.tier]||'') + ')');
        }
      } catch(e) {}
    }
  });
  if(newMedals) {
    saveMedals(earned);
    // Re-check allround medals since medal count changed
    const stats2 = getStats();
    MEDAL_DEFS.forEach(m => {
      if(m.series === 'allround' && !earned.includes(m.id)) {
        try {
          if(m.check(stats2)) {
            earned.push(m.id);
            showToast('解锁勋章! ' + m.icon + ' ' + m.name);
          }
        } catch(e) {}
      }
    });
    saveMedals(earned);
  }
}

function updateStreak() {
  const sd = loadStreakData();
  const today = todayKey();
  if(sd.lastDate === today) return; // Already counted today

  // Check if yesterday was active
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yKey = `${yesterday.getFullYear()}-${String(yesterday.getMonth()+1).padStart(2,'0')}-${String(yesterday.getDate()).padStart(2,'0')}`;

  if(sd.lastDate === yKey) {
    sd.count += 1;
  } else if(sd.lastDate !== today) {
    sd.count = 1; // Reset streak
  }
  sd.lastDate = today;
  if(!sd.history) sd.history = {};
  sd.history[today] = true;
  // Keep only last 60 days of history
  const keys = Object.keys(sd.history).sort();
  if(keys.length > 60) {
    keys.slice(0, keys.length - 60).forEach(k => delete sd.history[k]);
  }
  saveStreakData(sd);
}

function generateDailyChallenges() {
  const today = todayKey();
  const existing = loadData(LS_DAILY_CHALLENGE, {});
  if(existing.date === today && existing.challenges && existing.challenges.length === 3) {
    return existing;
  }
  // Pick 3 random non-duplicate challenges
  const pool = [...CHALLENGE_POOL];
  const selected = [];
  for(let i = 0; i < 3 && pool.length > 0; i++) {
    const idx = Math.floor(Math.random() * pool.length);
    const ch = pool.splice(idx, 1)[0];
    selected.push({type: ch.type, desc: ch.desc, icon: ch.icon, points: ch.points, completed: false});
  }
  const data = {date: today, challenges: selected};
  saveData(LS_DAILY_CHALLENGE, data);
  return data;
}

function checkDailyChallenge(type) {
  const today = todayKey();
  const dc = loadData(LS_DAILY_CHALLENGE, {});
  if(dc.date !== today || !dc.challenges) return;
  let changed = false;

  dc.challenges.forEach(ch => {
    if(ch.completed) return;
    let pass = false;
    if(ch.type === type) {
      if(type === 'complete_task' || type === 'record_health' || type === 'view_report' || type === 'add_goal' || type === 'high_priority' || type === 'all_modules') {
        pass = true;
      }
    }
    // Special check for complete_3_tasks
    if(ch.type === 'complete_3_tasks' && (type === 'complete_task' || type === 'high_priority')) {
      const tasks = loadTasks();
      if(tasks.filter(t => t.done).length >= 3) pass = true;
    }
    // Special check for steps_8000
    if(ch.type === 'steps_8000' && type === 'record_health') {
      if(healthData.steps >= 8000) pass = true;
    }
    if(pass) {
      ch.completed = true;
      changed = true;
      addPoints(ch.points, '每日挑战: ' + ch.desc);
    }
  });
  if(changed) saveData(LS_DAILY_CHALLENGE, dc);
}

function refreshAchievementTab() {
  renderLevelCard();
  renderStreakCard();
  renderChallenges();
  renderMedals();
  renderPointsLog();
}

function renderLevelCard() {
  const pd = loadPointsData();
  const lv = getLevel(pd.total);
  const nextLv = LEVELS.find(l => l.points > pd.total);
  document.getElementById('levelIcon').textContent = lv.icon;
  document.getElementById('levelName').textContent = lv.name;
  document.getElementById('levelLv').textContent = 'Lv.' + lv.lv;
  document.getElementById('levelPoints').textContent = pd.total + ' 积分';
  if(nextLv) {
    const progress = (pd.total - lv.points) / (nextLv.points - lv.points) * 100;
    document.getElementById('levelProgressFill').style.width = Math.min(100, Math.max(0, progress)) + '%';
    document.getElementById('levelProgressText').textContent = '还需 ' + (nextLv.points - pd.total) + ' 积分升至 ' + nextLv.name;
  } else {
    document.getElementById('levelProgressFill').style.width = '100%';
    document.getElementById('levelProgressText').textContent = '已达最高等级!';
  }
}

function renderStreakCard() {
  const sd = loadStreakData();
  document.getElementById('streakCount').textContent = sd.count || 0;

  const grid = document.getElementById('streakGrid');
  let html = '';
  const today = new Date();
  for(let i = 29; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const isToday = i === 0;
    let cls = 'streak-day';
    if(isToday) cls += ' today';
    if(sd.history && sd.history[key]) {
      // Determine activity level (simple: all active days get level 3)
      cls += ' active-3';
    }
    html += '<div class="' + cls + '" title="' + key + '"></div>';
  }
  grid.innerHTML = html;
}

function renderChallenges() {
  const dc = generateDailyChallenges();
  const container = document.getElementById('challengeCards');
  container.innerHTML = dc.challenges.map(ch => {
    const cls = ch.completed ? 'challenge-card completed' : 'challenge-card';
    const statusCls = ch.completed ? 'ch-status done' : 'ch-status pending';
    const statusText = ch.completed ? '已完成' : '未完成';
    return '<div class="' + cls + '">' +
      '<div class="ch-icon">' + ch.icon + '</div>' +
      '<div class="ch-desc">' + ch.desc + '</div>' +
      '<div class="ch-points">+' + ch.points + ' 积分</div>' +
      '<div class="' + statusCls + '">' + statusText + '</div>' +
    '</div>';
  }).join('');
}

function renderMedals() {
  const earned = loadMedals();
  const grid = document.getElementById('medalGrid');
  const tierLabels = {bronze:'铜', silver:'银', gold:'金', diamond:'钻石', special:'特殊'};
  grid.innerHTML = MEDAL_DEFS.map(m => {
    const unlocked = earned.includes(m.id);
    const cls = unlocked ? 'medal-item unlocked' : 'medal-item locked';
    return '<div class="' + cls + '">' +
      (unlocked ? '' : '<div class="medal-lock">🔒</div>') +
      '<span class="medal-icon">' + m.icon + '</span>' +
      '<div class="medal-name">' + m.name + '</div>' +
      '<div class="medal-desc">' + m.desc + '</div>' +
      '<div class="medal-tier">' + (tierLabels[m.tier] || '') + '</div>' +
    '</div>';
  }).join('');
}

function renderPointsLog() {
  const log = loadPointsLog();
  const container = document.getElementById('pointsLog');
  if(log.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:24px 0;color:var(--text3)"><div style="font-size:32px;margin-bottom:8px">📜</div><div style="font-size:13px">暂无记录，开始使用各模块来获取积分吧</div></div>';
    return;
  }
  const recent = log.slice(0, 10);
  container.innerHTML = recent.map(entry => {
    const d = new Date(entry.time);
    const timeStr = (d.getMonth()+1) + '/' + d.getDate() + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    return '<div class="points-log-item">' +
      '<div class="points-log-reason">' + entry.reason + '</div>' +
      '<div class="points-log-amount">+' + entry.amount + '</div>' +
      '<div class="points-log-time">' + timeStr + '</div>' +
    '</div>';
  }).join('');
}

// ============================================================
// ONBOARDING CARD
// ============================================================
function renderOnboarding() {
  var el = document.getElementById('onboardingCard');
  if(!el) return;
  if(localStorage.getItem('ln_onboarding_done') === '1') {
    el.innerHTML = '';
    el.style.display = 'none';
    return;
  }
  el.style.display = '';
  el.innerHTML =
    '<div class="onboarding-card">' +
      '<div class="onboarding-card-title">&#x1F44B; &#x6B22;&#x8FCE;&#x4F7F;&#x7528;&#x751F;&#x547D;&#x5BFC;&#x822A;</div>' +
      '<div class="onboarding-card-sub">&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF0C;&#x5F00;&#x542F;&#x4F60;&#x7684;&#x5065;&#x5EB7;&#x4E0E;&#x4EBA;&#x751F;&#x89C4;&#x5212;&#x4E4B;&#x65C5;</div>' +
      '<div class="onboarding-steps">' +
        '<div class="onboarding-step">' +
          '<div class="onboarding-step-icon">&#x1F4DD;</div>' +
          '<div class="onboarding-step-num">1</div>' +
          '<div class="onboarding-step-text">&#x5F55;&#x5165;&#x5065;&#x5EB7;&#x6570;&#x636E;</div>' +
        '</div>' +
        '<div class="onboarding-step">' +
          '<div class="onboarding-step-icon">&#x1F9E0;</div>' +
          '<div class="onboarding-step-num">2</div>' +
          '<div class="onboarding-step-text">AI &#x5206;&#x6790;&#x5065;&#x5EB7;</div>' +
        '</div>' +
        '<div class="onboarding-step">' +
          '<div class="onboarding-step-icon">&#x1F3AF;</div>' +
          '<div class="onboarding-step-num">3</div>' +
          '<div class="onboarding-step-text">&#x8BBE;&#x5B9A;&#x4EBA;&#x751F;&#x76EE;&#x6807;</div>' +
        '</div>' +
      '</div>' +
      '<div class="onboarding-actions">' +
        '<button class="btn btn-primary" onclick="openManualEntry()" style="flex:1;max-width:180px">&#x5F00;&#x59CB;&#x5F55;&#x5165;</button>' +
        '<button class="onboarding-dismiss" onclick="dismissOnboarding()">&#x5DF2;&#x4E86;&#x89E3;&#xFF0C;&#x4E0D;&#x518D;&#x663E;&#x793A;</button>' +
      '</div>' +
    '</div>';
}

function dismissOnboarding() {
  localStorage.setItem('ln_onboarding_done', '1');
  var el = document.getElementById('onboardingCard');
  if(el) {
    el.style.transition = 'opacity 0.3s, transform 0.3s';
    el.style.opacity = '0';
    el.style.transform = 'translateY(-10px)';
    setTimeout(function(){ el.innerHTML = ''; el.style.display = 'none'; }, 300);
  }
}

// ============================================================
// PERIODIC REPORT (Weekly / Monthly)
// ============================================================
function getDateRange(days) {
  var result = [];
  var now = new Date();
  for(var i = days - 1; i >= 0; i--) {
    var d = new Date(now);
    d.setDate(d.getDate() - i);
    result.push(d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'));
  }
  return result;
}

function switchPeriod(type) {
  document.getElementById('periodTabWeek').classList.toggle('active', type === 'week');
  document.getElementById('periodTabMonth').classList.toggle('active', type === 'month');
  var saveBtn = document.getElementById('savePeriodicBtn');
  if(saveBtn) saveBtn.style.display = '';
  generatePeriodicReport(type);
}

function generatePeriodicReport(type) {
  var days = type === 'week' ? 7 : 30;
  var dateRange = getDateRange(days);
  var periodLabel = type === 'week' ? '&#x672C;&#x5468;' : '&#x672C;&#x6708;';

  var healthResult = buildPeriodicHealthSection(dateRange, periodLabel);
  var taskResult = buildPeriodicTaskSection(dateRange, periodLabel);
  var achieveResult = buildPeriodicAchievementSection(dateRange, periodLabel);
  var insightsHtml = buildPeriodicInsights(type, healthResult.stats, taskResult.stats);

  var html = healthResult.html + taskResult.html + achieveResult.html + insightsHtml;

  if(!healthResult.hasData && !taskResult.hasData) {
    html = '<div class="period-no-data">&#x1F4AD; &#x8FD8;&#x6CA1;&#x6709;&#x8DB3;&#x591F;&#x7684;&#x6570;&#x636E;&#x751F;&#x6210;' + (type==='week'?'&#x5468;&#x62A5;':'&#x6708;&#x62A5;') + '<br>&#x5F00;&#x59CB;&#x5F55;&#x5165;&#x5065;&#x5EB7;&#x6570;&#x636E;&#x548C;&#x6BCF;&#x65E5;&#x4EFB;&#x52A1;&#x5427;&#xFF01;</div>';
  }

  // Add save button
  html += '<div class="period-save-btn">' +
    '<button class="btn btn-outline btn-save-report" onclick="savePeriodicReportAsImage()">&#x1F4E5; &#x4FDD;&#x5B58;' + (type==='week'?'&#x5468;&#x62A5;':'&#x6708;&#x62A5;') + '&#x4E3A;&#x56FE;&#x7247;</button>' +
  '</div>';

  document.getElementById('periodicReport').innerHTML = html;

  // Draw charts after DOM update
  setTimeout(function(){ drawPeriodicCharts(dateRange); }, 100);
}

function buildPeriodicHealthSection(dateRange, periodLabel) {
  var history = null;
  try { history = JSON.parse(localStorage.getItem('ln_health_history')); } catch(e){}
  if(!history) return { html: '', hasData: false, stats: {} };

  var metrics = [
    {key:'steps', name:'&#x6B65;&#x6570;', unit:'&#x6B65;', icon:'&#x1F6B6;'},
    {key:'heartrate', name:'&#x5FC3;&#x7387;', unit:'bpm', icon:'&#x2764;&#xFE0F;'},
    {key:'systolic', name:'&#x6536;&#x7F29;&#x538B;', unit:'mmHg', icon:'&#x1FA78;'},
    {key:'glucose', name:'&#x8840;&#x7CD6;', unit:'mmol/L', icon:'&#x1FA78;'},
    {key:'sleep', name:'&#x7761;&#x7720;', unit:'&#x5C0F;&#x65F6;', icon:'&#x1F634;'},
    {key:'weight', name:'&#x4F53;&#x91CD;', unit:'kg', icon:'&#x2696;&#xFE0F;'}
  ];

  var hasData = false;
  var statsOut = {};
  var statCards = '';

  metrics.forEach(function(m) {
    var entries = history[m.key];
    if(!entries || !entries.length) return;

    // Filter entries in date range
    var filtered = entries.filter(function(e) {
      return dateRange.indexOf(e.date) !== -1;
    });
    if(!filtered.length) return;
    hasData = true;

    var values = filtered.map(function(e){ return parseFloat(e.value); }).filter(function(v){ return !isNaN(v); });
    if(!values.length) return;

    var sum = values.reduce(function(a,b){ return a+b; }, 0);
    var avg = sum / values.length;
    var min = Math.min.apply(null, values);
    var max = Math.max.apply(null, values);

    // Trend: compare first half vs second half
    var mid = Math.floor(values.length / 2);
    var trend = 'flat';
    var trendPct = 0;
    if(values.length >= 2 && mid > 0) {
      var firstHalf = values.slice(0, mid).reduce(function(a,b){return a+b;},0) / mid;
      var secondHalf = values.slice(mid).reduce(function(a,b){return a+b;},0) / (values.length - mid);
      if(firstHalf > 0) {
        trendPct = ((secondHalf - firstHalf) / firstHalf * 100);
        if(trendPct > 2) trend = 'up';
        else if(trendPct < -2) trend = 'down';
      }
    }

    statsOut[m.key] = { avg: avg, min: min, max: max, trend: trend, trendPct: trendPct, count: values.length };

    var trendIcon = trend === 'up' ? '&#x2191;' : trend === 'down' ? '&#x2193;' : '&#x2192;';
    var trendClass = trend === 'up' ? 'period-trend-up' : trend === 'down' ? 'period-trend-down' : 'period-trend-flat';
    // For steps, up is good. For blood pressure/glucose, up may be bad
    if(m.key === 'systolic' || m.key === 'glucose') {
      trendClass = trend === 'up' ? 'period-trend-down' : trend === 'down' ? 'period-trend-up' : 'period-trend-flat';
    }

    statCards += '<div class="period-stat-item">' +
      '<div class="period-stat-label">' + m.icon + ' ' + m.name + '</div>' +
      '<div class="period-stat-value">' + (m.key === 'steps' ? Math.round(avg) : avg.toFixed(1)) + '<span style="font-size:12px;font-weight:400;color:var(--text2);margin-left:2px">' + m.unit + '</span></div>' +
      '<div class="period-stat-sub ' + trendClass + '">' + trendIcon + ' ' + Math.abs(trendPct).toFixed(1) + '%</div>' +
    '</div>';
  });

  if(!hasData) return { html: '', hasData: false, stats: statsOut };

  var html = '<div class="period-report-card">' +
    '<div class="period-report-card-title">&#x2764;&#xFE0F; &#x5065;&#x5EB7;&#x6570;&#x636E;&#x6982;&#x89C8;</div>' +
    '<div class="period-stat-grid">' + statCards + '</div>' +
    '<div class="period-chart-wrap"><canvas id="periodicHealthChart" height="160"></canvas></div>' +
  '</div>';

  return { html: html, hasData: true, stats: statsOut };
}

function buildPeriodicTaskSection(dateRange, periodLabel) {
  var totalTasks = 0, completedTasks = 0, activeDays = 0;

  dateRange.forEach(function(dateStr) {
    var tasks = null;
    try { tasks = JSON.parse(localStorage.getItem('ln_tasks_' + dateStr)); } catch(e){}
    if(!tasks || !tasks.length) return;
    activeDays++;
    totalTasks += tasks.length;
    completedTasks += tasks.filter(function(t){ return t.done; }).length;
  });

  var hasData = totalTasks > 0;
  var rate = totalTasks > 0 ? Math.round(completedTasks / totalTasks * 100) : 0;

  var statsOut = { total: totalTasks, completed: completedTasks, rate: rate, activeDays: activeDays };

  if(!hasData) return { html: '', hasData: false, stats: statsOut };

  var html = '<div class="period-report-card">' +
    '<div class="period-report-card-title">&#x2705; &#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x60C5;&#x51B5;</div>' +
    '<div class="period-stat-grid">' +
      '<div class="period-stat-item">' +
        '<div class="period-stat-label">&#x603B;&#x4EFB;&#x52A1;&#x6570;</div>' +
        '<div class="period-stat-value">' + totalTasks + '</div>' +
      '</div>' +
      '<div class="period-stat-item">' +
        '<div class="period-stat-label">&#x5DF2;&#x5B8C;&#x6210;</div>' +
        '<div class="period-stat-value" style="color:var(--green)">' + completedTasks + '</div>' +
      '</div>' +
      '<div class="period-stat-item">' +
        '<div class="period-stat-label">&#x5B8C;&#x6210;&#x7387;</div>' +
        '<div class="period-stat-value">' + rate + '<span style="font-size:12px;font-weight:400">%</span></div>' +
      '</div>' +
      '<div class="period-stat-item">' +
        '<div class="period-stat-label">&#x6D3B;&#x8DC3;&#x5929;&#x6570;</div>' +
        '<div class="period-stat-value">' + activeDays + '<span style="font-size:12px;font-weight:400;color:var(--text2)">/' + dateRange.length + '</span></div>' +
      '</div>' +
    '</div>' +
    '<div class="period-chart-wrap"><canvas id="periodicTaskChart" height="160"></canvas></div>' +
  '</div>';

  return { html: html, hasData: true, stats: statsOut };
}

function buildPeriodicAchievementSection(dateRange, periodLabel) {
  var pointsLog = null;
  try { pointsLog = JSON.parse(localStorage.getItem('ln_points_log')); } catch(e){}
  var pointsData = null;
  try { pointsData = JSON.parse(localStorage.getItem('ln_points')); } catch(e){}
  var streakData = null;
  try { streakData = JSON.parse(localStorage.getItem('ln_streak')); } catch(e){}

  var periodPoints = 0;
  var periodActivities = 0;

  if(pointsLog && pointsLog.length) {
    var startDate = dateRange[0];
    var endDate = dateRange[dateRange.length - 1];
    pointsLog.forEach(function(entry) {
      if(entry.date && entry.date.substring(0,10) >= startDate && entry.date.substring(0,10) <= endDate) {
        periodPoints += entry.points || 0;
        periodActivities++;
      }
    });
  }

  var totalPoints = pointsData ? (pointsData.total || 0) : 0;
  var level = pointsData ? (pointsData.level || 1) : 1;
  var streak = streakData ? (streakData.count || 0) : 0;

  var html = '<div class="period-report-card">' +
    '<div class="period-report-card-title">&#x1F3C6; &#x6210;&#x5C31;&#x6982;&#x89C8;</div>' +
    '<div class="period-stat-grid">' +
      '<div class="period-stat-item">' +
        '<div class="period-stat-label">&#x672C;&#x671F;&#x83B7;&#x5F97;&#x79EF;&#x5206;</div>' +
        '<div class="period-stat-value" style="color:var(--gold)">+' + periodPoints + '</div>' +
      '</div>' +
      '<div class="period-stat-item">' +
        '<div class="period-stat-label">&#x603B;&#x79EF;&#x5206;</div>' +
        '<div class="period-stat-value">' + totalPoints + '</div>' +
      '</div>' +
      '<div class="period-stat-item">' +
        '<div class="period-stat-label">&#x5F53;&#x524D;&#x7B49;&#x7EA7;</div>' +
        '<div class="period-stat-value">Lv.' + level + '</div>' +
      '</div>' +
      '<div class="period-stat-item">' +
        '<div class="period-stat-label">&#x8FDE;&#x7EED;&#x6253;&#x5361;</div>' +
        '<div class="period-stat-value">' + streak + '<span style="font-size:12px;font-weight:400;color:var(--text2)">&#x5929;</span></div>' +
      '</div>' +
    '</div>' +
  '</div>';

  return { html: html, hasData: periodPoints > 0, stats: { periodPoints: periodPoints, totalPoints: totalPoints, level: level, streak: streak } };
}

function buildPeriodicInsights(type, healthStats, taskStats) {
  var insights = [];
  var periodName = type === 'week' ? '&#x672C;&#x5468;' : '&#x672C;&#x6708;';

  // Health insights
  if(healthStats.steps) {
    var s = healthStats.steps;
    if(s.avg >= 8000) {
      insights.push({ type: 'good', icon: '&#x1F3C3;', text: periodName + '&#x5E73;&#x5747;&#x6B65;&#x6570; ' + Math.round(s.avg) + ' &#x6B65;&#xFF0C;&#x8FBE;&#x5230;&#x63A8;&#x8350;&#x8FD0;&#x52A8;&#x91CF;&#xFF0C;&#x7EE7;&#x7EED;&#x4FDD;&#x6301;&#xFF01;' });
    } else if(s.avg >= 5000) {
      insights.push({ type: 'info', icon: '&#x1F6B6;', text: periodName + '&#x5E73;&#x5747;&#x6B65;&#x6570; ' + Math.round(s.avg) + ' &#x6B65;&#xFF0C;&#x5EFA;&#x8BAE;&#x589E;&#x52A0;&#x5230; 8000 &#x6B65;&#x4EE5;&#x4E0A;' });
    } else if(s.avg > 0) {
      insights.push({ type: 'warn', icon: '&#x26A0;&#xFE0F;', text: periodName + '&#x5E73;&#x5747;&#x6B65;&#x6570;&#x4EC5; ' + Math.round(s.avg) + ' &#x6B65;&#xFF0C;&#x8FD0;&#x52A8;&#x91CF;&#x504F;&#x4F4E;&#xFF0C;&#x5EFA;&#x8BAE;&#x589E;&#x52A0;&#x65E5;&#x5E38;&#x6D3B;&#x52A8;' });
    }
  }

  if(healthStats.systolic) {
    var bp = healthStats.systolic;
    if(bp.avg > 140) {
      insights.push({ type: 'warn', icon: '&#x1FA78;', text: '&#x5E73;&#x5747;&#x6536;&#x7F29;&#x538B; ' + bp.avg.toFixed(0) + ' mmHg&#xFF0C;&#x504F;&#x9AD8;&#xFF0C;&#x5EFA;&#x8BAE;&#x5173;&#x6CE8;&#x5E76;&#x54A8;&#x8BE2;&#x533B;&#x751F;' });
    } else if(bp.avg >= 90 && bp.avg <= 120) {
      insights.push({ type: 'good', icon: '&#x1F49A;', text: '&#x8840;&#x538B;&#x6B63;&#x5E38;&#xFF0C;&#x5E73;&#x5747; ' + bp.avg.toFixed(0) + ' mmHg&#xFF0C;&#x4FDD;&#x6301;&#x826F;&#x597D;&#x4E60;&#x60EF;' });
    }
  }

  if(healthStats.sleep) {
    var sl = healthStats.sleep;
    if(sl.avg >= 7 && sl.avg <= 9) {
      insights.push({ type: 'good', icon: '&#x1F634;', text: '&#x5E73;&#x5747;&#x7761;&#x7720; ' + sl.avg.toFixed(1) + ' &#x5C0F;&#x65F6;&#xFF0C;&#x7761;&#x7720;&#x8D28;&#x91CF;&#x826F;&#x597D;' });
    } else if(sl.avg < 7 && sl.avg > 0) {
      insights.push({ type: 'warn', icon: '&#x1F634;', text: '&#x5E73;&#x5747;&#x7761;&#x7720;&#x4EC5; ' + sl.avg.toFixed(1) + ' &#x5C0F;&#x65F6;&#xFF0C;&#x5EFA;&#x8BAE;&#x4FDD;&#x8BC1; 7-9 &#x5C0F;&#x65F6;&#x7761;&#x7720;' });
    }
  }

  // Task insights
  if(taskStats && taskStats.total > 0) {
    if(taskStats.rate >= 80) {
      insights.push({ type: 'good', icon: '&#x2B50;', text: '&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x7387; ' + taskStats.rate + '%&#xFF0C;&#x6267;&#x884C;&#x529B;&#x5F88;&#x5F3A;&#xFF01;' });
    } else if(taskStats.rate >= 50) {
      insights.push({ type: 'info', icon: '&#x1F4CB;', text: '&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x7387; ' + taskStats.rate + '%&#xFF0C;&#x7EE7;&#x7EED;&#x52A0;&#x6CB9;&#xFF0C;&#x4E89;&#x53D6;&#x66F4;&#x9AD8;&#x7684;&#x5B8C;&#x6210;&#x7387;' });
    } else {
      insights.push({ type: 'warn', icon: '&#x1F4CB;', text: '&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x7387; ' + taskStats.rate + '%&#xFF0C;&#x5EFA;&#x8BAE;&#x5408;&#x7406;&#x5B89;&#x6392;&#x4EFB;&#x52A1;&#xFF0C;&#x907F;&#x514D;&#x8FC7;&#x591A;&#x79EF;&#x538B;' });
    }
  }

  if(!insights.length) return '';

  var html = '<div class="period-report-card">' +
    '<div class="period-report-card-title">&#x1F4A1; &#x667A;&#x80FD;&#x6D1E;&#x5BDF;</div>';
  insights.forEach(function(ins) {
    html += '<div class="period-insight period-insight-' + ins.type + '">' +
      '<span class="period-insight-icon">' + ins.icon + '</span>' +
      '<span>' + ins.text + '</span>' +
    '</div>';
  });
  html += '</div>';
  return html;
}

function drawPeriodicCharts(dateRange) {
  if(typeof Chart === 'undefined') return;

  // Health chart - steps per day
  var healthCanvas = document.getElementById('periodicHealthChart');
  if(healthCanvas) {
    var history = null;
    try { history = JSON.parse(localStorage.getItem('ln_health_history')); } catch(e){}
    if(history && history.steps) {
      var labels = [];
      var stepsData = [];
      dateRange.forEach(function(dateStr) {
        var parts = dateStr.split('-');
        labels.push(parts[1] + '/' + parts[2]);
        var entry = history.steps.find(function(e){ return e.date === dateStr; });
        stepsData.push(entry ? parseFloat(entry.value) : 0);
      });

      // Destroy old chart if exists
      if(healthCanvas._chartInstance) healthCanvas._chartInstance.destroy();

      var ctx = healthCanvas.getContext('2d');
      healthCanvas._chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '\u6B65\u6570',
            data: stepsData,
            backgroundColor: 'rgba(42,157,143,0.5)',
            borderColor: 'rgba(42,157,143,1)',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 45 } },
            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 10 } } }
          }
        }
      });
    }
  }

  // Task chart - completion per day
  var taskCanvas = document.getElementById('periodicTaskChart');
  if(taskCanvas) {
    var tLabels = [];
    var totalData = [];
    var doneData = [];

    dateRange.forEach(function(dateStr) {
      var parts = dateStr.split('-');
      tLabels.push(parts[1] + '/' + parts[2]);
      var tasks = null;
      try { tasks = JSON.parse(localStorage.getItem('ln_tasks_' + dateStr)); } catch(e){}
      totalData.push(tasks ? tasks.length : 0);
      doneData.push(tasks ? tasks.filter(function(t){ return t.done; }).length : 0);
    });

    if(taskCanvas._chartInstance) taskCanvas._chartInstance.destroy();

    var ctx2 = taskCanvas.getContext('2d');
    taskCanvas._chartInstance = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: tLabels,
        datasets: [
          {
            label: '\u603B\u4EFB\u52A1',
            data: totalData,
            backgroundColor: 'rgba(120,90,60,0.15)',
            borderColor: 'rgba(120,90,60,0.3)',
            borderWidth: 1,
            borderRadius: 4
          },
          {
            label: '\u5DF2\u5B8C\u6210',
            data: doneData,
            backgroundColor: 'rgba(64,145,108,0.5)',
            borderColor: 'rgba(64,145,108,1)',
            borderWidth: 1,
            borderRadius: 4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { font: { size: 11 }, usePointStyle: true, pointStyle: 'rectRounded' } } },
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 45 } },
          y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 10 }, stepSize: 1 } }
        }
      }
    });
  }
}

function savePeriodicReportAsImage() {
  if(!window.html2canvas) {
    alert('图片导出功能正在加载，请稍后再试');
    return;
  }
  var container = document.getElementById('periodicReport');
  if(!container || !container.innerHTML.trim()) {
    alert('没有可保存的报告内容');
    return;
  }
  var btn = event.target;
  var origText = btn.innerHTML;
  btn.innerHTML = '&#x23F3; &#x6B63;&#x5728;&#x751F;&#x6210;&#x56FE;&#x7247;...';
  btn.disabled = true;
  html2canvas(container, {
    backgroundColor: '#FFFFFF',
    scale: 2,
    useCORS: true,
    logging: false
  }).then(function(canvas) {
    canvas.toBlob(function(blob) {
      var now = new Date();
      var dateStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
      var periodType = document.getElementById('periodTabWeek').classList.contains('active') ? '周报' : '月报';
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = '生命导航_' + periodType + '_' + dateStr + '.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      btn.innerHTML = origText;
      btn.disabled = false;
      addPoints(5, '保存' + periodType);
    }, 'image/png');
  }).catch(function(err) {
    console.error('html2canvas error:', err);
    btn.innerHTML = origText;
    btn.disabled = false;
    alert('图片生成失败，请重试');
  });
}

// ============================================================
// INIT
// ============================================================
function init() {
  renderDevices();
  renderMetrics();
  renderOnboarding();
  refreshTimeTab();

  // Close modals on overlay click
  document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', (e) => {
      if(e.target === m) m.classList.remove('show');
    });
  });

  // Life clock animation
  let pred = calcPrediction();
  function animateLifeClock() {
    if(currentTab === 1) {
      pred = calcPrediction();
      drawLifeClock(pred);
    }
    requestAnimationFrame(animateLifeClock);
  }
  animateLifeClock();

  // Generate initial periodic report
  try { generatePeriodicReport('week'); } catch(e) { console.log('Periodic report init error:', e); }
}

// Auth-gated startup: check login before initializing app
checkAuth();
</script>

<!-- Sidebar auth integration: override updateAuthUI to populate sidebar footer -->
<script>
(function(){
  const _origUpdateAuthUI = updateAuthUI;
  updateAuthUI = function() {
    _origUpdateAuthUI();
    const user = getAuthUser();
    const userEl = document.getElementById('sidebarUser');
    const logoutEl = document.getElementById('sidebarLogout');
    if(userEl && logoutEl){
      if(user && user.phone){
        userEl.innerHTML = '&#x1F464; ' + user.phone;
        logoutEl.style.display = '';
      } else {
        userEl.textContent = '';
        logoutEl.style.display = 'none';
      }
    }
  };
  // Re-call to apply sidebar state (since checkAuth ran before this override)
  updateAuthUI();
})();
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/v67327c56f0bb4ef8b305cae61679db8f1769101564043" integrity="sha512-rdcWY47ByXd76cbCFzznIcEaCN71jqkWBBqlwhF1SY7KubdLKZiEGeP7AyieKZlGP9hbY/MhGrwXzJC/HulNyg==" data-cf-beacon='{"version":"2024.11.0","token":"75124c326cb447fe934cde04713ae013","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>